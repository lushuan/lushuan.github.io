<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Nginx 常用配置 - Less is more</title><meta name="Description" content="晚来天欲雪,能饮一杯无?"><meta property="og:title" content="Nginx 常用配置" />
<meta property="og:description" content="背景 整理在使用 Nginx 过程中频繁使用的Nginx 常用配置，另外补充一些常用命令和解决方案 Nginx 命令行常用命令 nginx -s reload # 向主进程发送信号，重新加载配置文件" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://lushuan.gihub.io/nginx%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/" /><meta property="og:image" content="https://lushuan.gihub.io/images/avatar.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-01-13T12:06:37+08:00" />
<meta property="article:modified_time" content="2022-06-26T12:06:37+08:00" /><meta property="og:site_name" content="我的网站" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://lushuan.gihub.io/images/avatar.png"/>

<meta name="twitter:title" content="Nginx 常用配置"/>
<meta name="twitter:description" content="背景 整理在使用 Nginx 过程中频繁使用的Nginx 常用配置，另外补充一些常用命令和解决方案 Nginx 命令行常用命令 nginx -s reload # 向主进程发送信号，重新加载配置文件"/>
<meta name="application-name" content="我的网站">
<meta name="apple-mobile-web-app-title" content="我的网站"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="/images/avatar.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://lushuan.gihub.io/nginx%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/" /><link rel="prev" href="https://lushuan.gihub.io/nginx%E6%97%A5%E5%B8%B8%E5%B7%A5%E4%BD%9C%E5%B8%B8%E7%94%A8%E8%84%9A%E6%9C%AC/" /><link rel="next" href="https://lushuan.gihub.io/nginx%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Nginx 常用配置",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/lushuan.gihub.io\/nginx%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE\/"
        },"genre": "posts","keywords": "Nginx","wordcount":  14031 ,
        "url": "https:\/\/lushuan.gihub.io\/nginx%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE\/","datePublished": "2022-01-13T12:06:37+08:00","dateModified": "2022-06-26T12:06:37+08:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "lushuan"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Less is more"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/images/avatar.png"
        data-srcset="/images/avatar.png, /images/avatar.png 1.5x, /images/avatar.png 2x"
        data-sizes="auto"
        alt="/images/avatar.png"
        title="/images/avatar.png" />Less is more</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 归档 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about/" title="About"> 关于 </a><a class="menu-item" href="/friends/" title="friends"> 友链 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Less is more"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/images/avatar.png"
        data-srcset="/images/avatar.png, /images/avatar.png 1.5x, /images/avatar.png 2x"
        data-sizes="auto"
        alt="/images/avatar.png"
        title="/images/avatar.png" />Less is more</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">归档</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/" title="About">关于</a><a class="menu-item" href="/friends/" title="friends">友链</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content always-active" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Nginx 常用配置</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>lushuan</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/nginx/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>Nginx</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2022-01-13">2022-01-13</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;约 14031 字&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;预计阅读 29 分钟&nbsp;<span id="/nginx%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/" class="leancloud_visitors" data-flag-title="Nginx 常用配置">
                        <i class="far fa-eye fa-fw" aria-hidden="true"></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;次阅读
                    </span>&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#背景">背景</a></li>
    <li><a href="#nginx-命令行常用命令">Nginx 命令行常用命令</a></li>
    <li><a href="#常用模块">常用模块</a></li>
    <li><a href="#nginx-核心配置">Nginx 核心配置</a>
      <ul>
        <li><a href="#配置块嵌套">配置块嵌套</a></li>
        <li><a href="#nginx-默认配置文件">Nginx 默认配置文件</a></li>
        <li><a href="#http-location-指令模块">Http Location 指令模块</a></li>
      </ul>
    </li>
    <li><a href="#nginx-场景方案">Nginx 场景方案</a>
      <ul>
        <li><a href="#nginx-配置动静分离">Nginx 配置动静分离</a>
          <ul>
            <li><a href="#什么是动静分离">什么是动静分离</a></li>
            <li><a href="#动静分离方案">动静分离方案</a></li>
          </ul>
        </li>
        <li><a href="#nginx-配置反向代理">nginx 配置反向代理</a></li>
        <li><a href="#nginx-负载均衡配置">Nginx 负载均衡配置</a>
          <ul>
            <li><a href="#常用负载均衡策略">常用负载均衡策略</a></li>
          </ul>
        </li>
        <li><a href="#nginx-配置跨域">Nginx 配置跨域</a></li>
        <li><a href="#urlrewrite-伪静态配置">URLRewrite 伪静态配置</a></li>
        <li><a href="#配置防盗链">配置防盗链</a></li>
        <li><a href="#nginx-高可用配置">Nginx 高可用配置</a></li>
        <li><a href="#nginx-https-加密认证访问">Nginx https 加密认证访问</a>
          <ul>
            <li><a href="#https-证书配置">https 证书配置</a></li>
            <li><a href="#证书自签名">证书自签名</a></li>
          </ul>
        </li>
        <li><a href="#nginx-开启http并重定向到https">Nginx 开启http并重定向到https</a>
          <ul>
            <li><a href="#开启http">开启http</a></li>
            <li><a href="#重定向到https的两种方式">重定向到https的两种方式</a></li>
          </ul>
        </li>
        <li><a href="#nginx-对客户端和上游服务器使用keepalive-配置详解">nginx 对客户端和上游服务器使用keepalive 配置详解</a>
          <ul>
            <li><a href="#1-http-keepalive">1. HTTP Keepalive</a></li>
          </ul>
        </li>
        <li><a href="#2-upstream-keepalive">2. Upstream Keepalive</a>
          <ul>
            <li><a href="#注意事项">注意事项</a></li>
          </ul>
        </li>
        <li><a href="#nginx-内存与文件缓冲区">Nginx 内存与文件缓冲区</a>
          <ul>
            <li><a href="#header-缓冲区">Header 缓冲区</a></li>
            <li><a href="#body-缓冲区">Body 缓冲区</a></li>
          </ul>
        </li>
        <li><a href="#nginx-对客户端的限制">Nginx 对客户端的限制</a>
          <ul>
            <li><a href="#关键词解释">关键词解释</a></li>
            <li><a href="#配置示例">配置示例</a></li>
            <li><a href="#补充说明">补充说明</a></li>
          </ul>
        </li>
        <li><a href="#nginx-gzip压缩">Nginx Gzip压缩</a>
          <ul>
            <li><a href="#gzip-动态压缩及缺点">Gzip 动态压缩及缺点</a></li>
            <li><a href="#gzip-静态压缩">Gzip 静态压缩</a></li>
          </ul>
        </li>
        <li><a href="#nginx-配置正向代理与反向代理缓存">Nginx 配置正向代理与反向代理缓存</a>
          <ul>
            <li><a href="#提高响应速度">提高响应速度</a></li>
            <li><a href="#增强系统的可扩展性和稳定性">增强系统的可扩展性和稳定性</a></li>
            <li><a href="#优化资源利用">优化资源利用</a></li>
            <li><a href="#灵活的配置选项">灵活的配置选项</a></li>
            <li><a href="#实现简单且高效">实现简单且高效</a></li>
          </ul>
        </li>
        <li><a href="#nginx-配置带宽限制">Nginx 配置带宽限制</a>
          <ul>
            <li><a href="#场景一限制客户端下载速度">场景一：限制客户端下载速度</a></li>
            <li><a href="#场景二基于连接数和请求频率的流量控制">场景二：基于连接数和请求频率的流量控制</a></li>
            <li><a href="#场景三针对不同用户组应用不同的带宽限制">场景三：针对不同用户组应用不同的带宽限制</a></li>
          </ul>
        </li>
        <li><a href="#nginx-并发数限制">Nginx 并发数限制</a>
          <ul>
            <li><a href="#场景一限制单个ip地址的最大并发连接数">场景一：限制单个IP地址的最大并发连接数</a></li>
            <li><a href="#场景二根据不同的url路径应用不同的并发限制">场景二：根据不同的URL路径应用不同的并发限制</a></li>
            <li><a href="#场景三结合速率限制与并发限制">场景三：结合速率限制与并发限制</a></li>
          </ul>
        </li>
        <li><a href="#nginx-日志管理">Nginx 日志管理</a>
          <ul>
            <li><a href="#日志内存缓冲区">日志内存缓冲区</a></li>
            <li><a href="#json格式输出">json格式输出</a></li>
            <li><a href="#日志切割">日志切割</a>
              <ul>
                <li><a href="#使用-logrotate-工具推荐">使用 <code>logrotate</code> 工具（推荐）</a>
                  <ul>
                    <li><a href="#步骤"><strong>步骤：</strong></a></li>
                  </ul>
                </li>
                <li><a href="#关键注意事项"><strong>关键注意事项</strong></a></li>
                <li><a href="#配置多个目录的方式">配置多个目录的方式</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#nginx-upsream-重试机制">Nginx upsream 重试机制</a>
          <ul>
            <li><a href="#被动态式重试机制">被动态式重试机制</a></li>
            <li><a href="#主动重试机制">主动重试机制</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="背景">背景</h2>
<p>整理在使用 Nginx 过程中频繁使用的Nginx 常用配置，另外补充一些常用命令和解决方案</p>
<h2 id="nginx-命令行常用命令">Nginx 命令行常用命令</h2>
<ul>
<li>nginx -s reload # 向主进程发送信号，重新加载配置文件，热重启</li>
<li>nginx -s reopen # 重启 Nginx</li>
<li>nginx -s stop # 快速关闭</li>
<li>nginx -s quit # 等待工作进程处理完成后关闭</li>
<li>nginx -t # 查看当前 Nginx 配置是否有错误</li>
<li>nginx -t -c &lt;配置路径&gt; # 检查配置是否有问题，如果已经在配置目录，则不需要 - c</li>
</ul>
<h2 id="常用模块">常用模块</h2>
<p>nginx模块分为两种，官方和第三方，我们通过命令 nginx -V 查看 nginx已经安装的模块</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-v" data-lang="v"><span class="line"><span class="cl"><span class="p">[</span><span class="na">root</span><span class="err">@</span><span class="na">www</span> <span class="err">~</span><span class="p">]</span><span class="o">#</span> <span class="nv">nginx</span> <span class="o">-</span><span class="nc">V</span>
</span></span><span class="line"><span class="cl"><span class="nv">nginx</span> <span class="nv">version</span><span class="p">:</span> <span class="nv">nginx</span><span class="o">/</span><span class="mf">1.20.1</span>
</span></span><span class="line"><span class="cl"><span class="nv">built</span> <span class="nv">by</span> <span class="nv">gcc</span> <span class="mf">4.8.5</span> <span class="mi">20150623</span> <span class="p">(</span><span class="nc">Red</span> <span class="nc">Hat</span> <span class="mf">4.8.5</span><span class="o">-</span><span class="mi">44</span><span class="p">)</span> <span class="p">(</span><span class="nc">GCC</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="nv">built</span> <span class="nv">with</span> <span class="nc">OpenSSL</span> <span class="mf">1.1.1</span><span class="nv">k</span>  <span class="nc">FIPS</span> <span class="mi">25</span> <span class="nc">Mar</span> <span class="mi">2021</span>
</span></span><span class="line"><span class="cl"><span class="nc">TLS</span> <span class="nc">SNI</span> <span class="nv">support</span> <span class="nv">enabled</span>
</span></span><span class="line"><span class="cl"><span class="nv">configure</span> <span class="nv">arguments</span><span class="p">:</span> <span class="o">--</span><span class="nv">prefix</span><span class="o">=/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">share</span><span class="o">/</span><span class="nv">nginx</span> <span class="o">--</span><span class="nv">sbin</span><span class="o">-</span><span class="nv">path</span><span class="o">=/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">sbin</span><span class="o">/</span><span class="nv">nginx</span> <span class="o">--</span><span class="nv">modules</span><span class="o">-</span><span class="nv">path</span><span class="o">=/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">lib64</span><span class="o">/</span><span class="nv">nginx</span><span class="o">/</span><span class="nv">modules</span> <span class="o">--</span><span class="nv">conf</span><span class="o">-</span><span class="nv">path</span><span class="o">=/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">nginx</span><span class="o">/</span><span class="nv">nginx</span><span class="p">.</span><span class="nv">conf</span> <span class="o">--</span><span class="kt">error</span><span class="o">-</span><span class="nv">log</span><span class="o">-</span><span class="nv">path</span><span class="o">=/</span><span class="nv">var</span><span class="o">/</span><span class="nv">log</span><span class="o">/</span><span class="nv">nginx</span><span class="o">/</span><span class="kt">error</span><span class="p">.</span><span class="nv">log</span> <span class="o">--</span><span class="nv">http</span><span class="o">-</span><span class="nv">log</span><span class="o">-</span><span class="nv">path</span><span class="o">=/</span><span class="nv">var</span><span class="o">/</span><span class="nv">log</span><span class="o">/</span><span class="nv">nginx</span><span class="o">/</span><span class="nv">access</span><span class="p">.</span><span class="nv">log</span> <span class="o">--</span><span class="nv">http</span><span class="o">-</span><span class="nv">client</span><span class="o">-</span><span class="nv">body</span><span class="o">-</span><span class="nv">temp</span><span class="o">-</span><span class="nv">path</span><span class="o">=/</span><span class="nv">var</span><span class="o">/</span><span class="nv">lib</span><span class="o">/</span><span class="nv">nginx</span><span class="o">/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">client_body</span> <span class="o">--</span><span class="nv">http</span><span class="o">-</span><span class="nv">proxy</span><span class="o">-</span><span class="nv">temp</span><span class="o">-</span><span class="nv">path</span><span class="o">=/</span><span class="nv">var</span><span class="o">/</span><span class="nv">lib</span><span class="o">/</span><span class="nv">nginx</span><span class="o">/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">proxy</span> <span class="o">--</span><span class="nv">http</span><span class="o">-</span><span class="nv">fastcgi</span><span class="o">-</span><span class="nv">temp</span><span class="o">-</span><span class="nv">path</span><span class="o">=/</span><span class="nv">var</span><span class="o">/</span><span class="nv">lib</span><span class="o">/</span><span class="nv">nginx</span><span class="o">/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">fastcgi</span> <span class="o">--</span><span class="nv">http</span><span class="o">-</span><span class="nv">uwsgi</span><span class="o">-</span><span class="nv">temp</span><span class="o">-</span><span class="nv">path</span><span class="o">=/</span><span class="nv">var</span><span class="o">/</span><span class="nv">lib</span><span class="o">/</span><span class="nv">nginx</span><span class="o">/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">uwsgi</span> <span class="o">--</span><span class="nv">http</span><span class="o">-</span><span class="nv">scgi</span><span class="o">-</span><span class="nv">temp</span><span class="o">-</span><span class="nv">path</span><span class="o">=/</span><span class="nv">var</span><span class="o">/</span><span class="nv">lib</span><span class="o">/</span><span class="nv">nginx</span><span class="o">/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">scgi</span> <span class="o">--</span><span class="nv">pid</span><span class="o">-</span><span class="nv">path</span><span class="o">=/</span><span class="nv">run</span><span class="o">/</span><span class="nv">nginx</span><span class="p">.</span><span class="nv">pid</span> <span class="o">--</span><span class="k">lock</span><span class="o">-</span><span class="nv">path</span><span class="o">=/</span><span class="nv">run</span><span class="o">/</span><span class="k">lock</span><span class="o">/</span><span class="nv">subsys</span><span class="o">/</span><span class="nv">nginx</span> <span class="o">--</span><span class="nv">user</span><span class="o">=</span><span class="nv">nginx</span> <span class="o">--</span><span class="nv">group</span><span class="o">=</span><span class="nv">nginx</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">compat</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">debug</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">file</span><span class="o">-</span><span class="nv">aio</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">google_perftools_module</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">http_addition_module</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">http_auth_request_module</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">http_dav_module</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">http_degradation_module</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">http_flv_module</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">http_gunzip_module</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">http_gzip_static_module</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">http_image_filter_module</span><span class="o">=</span><span class="nv">dynamic</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">http_mp4_module</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">http_perl_module</span><span class="o">=</span><span class="nv">dynamic</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">http_random_index_module</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">http_realip_module</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">http_secure_link_module</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">http_slice_module</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">http_ssl_module</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">http_stub_status_module</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">http_sub_module</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">http_v2_module</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">http_xslt_module</span><span class="o">=</span><span class="nv">dynamic</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">mail</span><span class="o">=</span><span class="nv">dynamic</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">mail_ssl_module</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">pcre</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">pcre</span><span class="o">-</span><span class="nv">jit</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">stream</span><span class="o">=</span><span class="nv">dynamic</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">stream_ssl_module</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">stream_ssl_preread_module</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">threads</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">cc</span><span class="o">-</span><span class="nv">opt</span><span class="o">=</span><span class="s1">&#39;-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -m64 -mtune=generic&#39;</span> <span class="o">--</span><span class="nv">with</span><span class="o">-</span><span class="nv">ld</span><span class="o">-</span><span class="nv">opt</span><span class="o">=</span><span class="s1">&#39;-Wl,-z,relro -specs=/usr/lib/rpm/redhat/redhat-hardened-ld -Wl,-E&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th>Nginx模块名称</th>
<th>模块作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>ngx_http_access_module</td>
<td>四层基于IP的访问控制，可以通过匹配客户端源IP地址进行限制</td>
</tr>
<tr>
<td>ngx_http_auth_basic_module</td>
<td>状态页，使用basic机制进行用户认证，在编译安装nginx的时候需要添加编译参数&ndash;withhttp_stub_status_module，否则配置完成之后监测会是提示语法错误</td>
</tr>
<tr>
<td>ngx_http_stub_status_module</td>
<td>状态统计模块</td>
</tr>
<tr>
<td>ngx_http_gzip_module</td>
<td>文件的压缩功能</td>
</tr>
<tr>
<td>ngx_http_gzip_static_module</td>
<td>静态压缩模块</td>
</tr>
<tr>
<td>ngx_http_ssl_module</td>
<td>nginx 的https 功能</td>
</tr>
<tr>
<td>ngx_http_rewrite_module</td>
<td>重定向模块，解析和处理rewrite请求</td>
</tr>
<tr>
<td>ngx_http_referer_module</td>
<td>防盗链功能，基于访问安全考虑</td>
</tr>
<tr>
<td>ngx_http_proxy_module</td>
<td>将客户端的请求以http协议转发至指定服务器进行处理</td>
</tr>
<tr>
<td>ngx_stream_proxy_module</td>
<td>tcp负载，将客户端的请求以tcp协议转发至指定服务器处理</td>
</tr>
<tr>
<td>ngx_http_fastcgi_module</td>
<td>将客户端对php的请求以fastcgi协议转发至指定服务器助理</td>
</tr>
<tr>
<td>ngx_http_uwsgi_module</td>
<td>将客户端对Python的请求以uwsgi协议转发至指定服务器处理</td>
</tr>
<tr>
<td>ngx_http_headers_module</td>
<td>可以实现对头部报文添加指定的key与值</td>
</tr>
<tr>
<td>ngx_http_upstream_module</td>
<td>负载均衡模块，提供服务器分组转发、权重分配、状态监测、调度算法等高级功能</td>
</tr>
<tr>
<td>ngx_stream_upstream_module</td>
<td>后端服务器分组转发、权重分配、状态监测、调度算法等高级功能</td>
</tr>
<tr>
<td>ngx_http_fastcgi_module</td>
<td>实现通过fastcgi协议将指定的客户端请求转发至php-fpm处理</td>
</tr>
<tr>
<td>ngx_http_flv_module</td>
<td>为flv伪流媒体服务端提供支持</td>
</tr>
</tbody>
</table>
<h2 id="nginx-核心配置">Nginx 核心配置</h2>
<h3 id="配置块嵌套">配置块嵌套</h3>
<p><figure><a class="lightgallery" href="/images/nginx/nginx-configuration-inner.png" title="nginx-configuration-inner" data-thumbnail="/images/nginx/nginx-configuration-inner.png" data-sub-html="<h2>配置块嵌套</h2><p>nginx-configuration-inner</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/nginx/nginx-configuration-inner.png"
            data-srcset="/images/nginx/nginx-configuration-inner.png, /images/nginx/nginx-configuration-inner.png 1.5x, /images/nginx/nginx-configuration-inner.png 2x"
            data-sizes="auto"
            alt="/images/nginx/nginx-configuration-inner.png" />
    </a><figcaption class="image-caption">配置块嵌套</figcaption>
    </figure></p>
<h3 id="nginx-默认配置文件">Nginx 默认配置文件</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[root@www nginx]# cat nginx.conf|grep -v \#
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">user nginx;
</span></span><span class="line"><span class="cl">worker_processes auto;
</span></span><span class="line"><span class="cl">error_log /var/log/nginx/error.log;
</span></span><span class="line"><span class="cl">pid /run/nginx.pid;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">include /usr/share/nginx/modules/*.conf;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">events {
</span></span><span class="line"><span class="cl">    worker_connections 1024;
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">http {
</span></span><span class="line"><span class="cl">	# 数据传输性能相关的参数;
</span></span><span class="line"><span class="cl">    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &#34;$request&#34; &#39;
</span></span><span class="line"><span class="cl">                      &#39;$status $body_bytes_sent &#34;$http_referer&#34; &#39;
</span></span><span class="line"><span class="cl">                      &#39;&#34;$http_user_agent&#34; &#34;$http_x_forwarded_for&#34;&#39;;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    access_log  /var/log/nginx/access.log  main;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    sendfile            on;
</span></span><span class="line"><span class="cl">    tcp_nopush          on;
</span></span><span class="line"><span class="cl">    tcp_nodelay         on;
</span></span><span class="line"><span class="cl">    keepalive_timeout   65;
</span></span><span class="line"><span class="cl">    types_hash_max_size 4096;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    include             /etc/nginx/mime.types;
</span></span><span class="line"><span class="cl">    default_type        application/octet-stream;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    include /etc/nginx/conf.d/*.conf;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    server {
</span></span><span class="line"><span class="cl">    	# 端口号
</span></span><span class="line"><span class="cl">        listen       80;  
</span></span><span class="line"><span class="cl">        listen       [::]:80;
</span></span><span class="line"><span class="cl">        # server_name 指令后可以跟多个指令，第一个为主域名
</span></span><span class="line"><span class="cl">        server_name  _; #不做域名匹配，只根据虚拟主机内的port去匹配
</span></span><span class="line"><span class="cl">        root         /usr/share/nginx/html;
</span></span><span class="line"><span class="cl">		# 模块化引入外部配置
</span></span><span class="line"><span class="cl">        include /etc/nginx/default.d/*.conf;
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		# nginx强大的基于url处理用户请求，就是基于location来的
</span></span><span class="line"><span class="cl">        location / {
</span></span><span class="line"><span class="cl">            # 定义网站根目录
</span></span><span class="line"><span class="cl">            root  /usr/share/nginx/html;
</span></span><span class="line"><span class="cl">            # 定义首页文件
</span></span><span class="line"><span class="cl">            index   index.html;
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">  	
</span></span><span class="line"><span class="cl">        error_page 404 /404.html;
</span></span><span class="line"><span class="cl">        location = /404.html {
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        error_page 500 502 503 504 /50x.html;
</span></span><span class="line"><span class="cl">        location = /50x.html {
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>main: 全局设置</li>
<li>events: 配置影响 Nginx 服务器或与用户的网络连接</li>
<li>http:http 模块设置</li>
<li>upstream: 负载均衡设置</li>
<li>server:http 服务器配置，一个 http 模块中可以有多个 server 模块</li>
<li>location:url 匹配配置，一个 server 模块中可以包含多个 location 模块</li>
</ul>
<p>一个 nginx 配置文件的结构就像 nginx.conf 显示的那样，配置文件的语法规则：</p>
<ol>
<li>配置文件由模块组成</li>
<li>使用#添加注释</li>
<li>使用 $ 使用变量</li>
<li>使用 include 引用多个配置文件</li>
<li>每一条语句结尾必须是分号结束</li>
<li>以区段形式的配置参数，需要有闭合的花括号 {}</li>
<li>不同作用域的配置参数，不能瞎嵌套
<ul>
<li>server{}是用于定义nginx的 http核心模块功能的子配置，必须防止在http{}括号外中</li>
<li>写在http{}外层，与其同级，语法报错</li>
</ul>
</li>
<li>include配置参数：<code>include /etc/nginx/default.d/*.conf;</code>
<ul>
<li>导入外部的配置文件，优化，简化主配置文件的格式</li>
<li>http{}利用include导入外部的 server{}配置</li>
<li>include得写在http{}花括号内，才表示给这个区域导入外部的配置文件</li>
<li>只针对http{}区域生效</li>
</ul>
</li>
</ol>
<h3 id="http-location-指令模块">Http Location 指令模块</h3>
<p>location 是 <code>ngx_http_core_module</code> 核心模块下的指令，并且是最常用的指令，这里做一下整理记录</p>
<p><figure><a class="lightgallery" href="/images/nginx/nginx-location-match-uri.png" title="nginx-location-match-uri" data-thumbnail="/images/nginx/nginx-location-match-uri.png" data-sub-html="<h2>location 匹配规则</h2><p>nginx-location-match-uri</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/nginx/nginx-location-match-uri.png"
            data-srcset="/images/nginx/nginx-location-match-uri.png, /images/nginx/nginx-location-match-uri.png 1.5x, /images/nginx/nginx-location-match-uri.png 2x"
            data-sizes="auto"
            alt="/images/nginx/nginx-location-match-uri.png" />
    </a><figcaption class="image-caption">location 匹配规则</figcaption>
    </figure>
指令的Location</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Syntax:	location [ = | ~ | ~* | ^~ ] uri { ... }
</span></span><span class="line"><span class="cl">location @name { ... }
</span></span><span class="line"><span class="cl">Default:	—
</span></span><span class="line"><span class="cl">Context:	server, location
</span></span></code></pre></td></tr></table>
</div>
</div><p><figure><a class="lightgallery" href="/images/nginx/nginx-http-location-match-sx.png" title="nginx-http-location-match-sx" data-thumbnail="/images/nginx/nginx-http-location-match-sx.png" data-sub-html="<h2>location 匹配顺序</h2><p>nginx-http-location-match-sx</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="/images/nginx/nginx-http-location-match-sx.png"
            data-srcset="/images/nginx/nginx-http-location-match-sx.png, /images/nginx/nginx-http-location-match-sx.png 1.5x, /images/nginx/nginx-http-location-match-sx.png 2x"
            data-sizes="auto"
            alt="/images/nginx/nginx-http-location-match-sx.png" />
    </a><figcaption class="image-caption">location 匹配顺序</figcaption>
    </figure></p>
<p>举例</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># = 精确匹配
</span></span><span class="line"><span class="cl">location = / {
</span></span><span class="line"><span class="cl">    [ configuration A ]
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">location / {
</span></span><span class="line"><span class="cl">    [ configuration B ]
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">location /documents/ {
</span></span><span class="line"><span class="cl">    [ configuration C ]
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">location ^~ /images/ {
</span></span><span class="line"><span class="cl">    [ configuration D ]
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">location ~* \.(gif|jpg|jpeg)$ {
</span></span><span class="line"><span class="cl">    [ configuration E ]
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><div class="details admonition example open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-list-ol fa-fw" aria-hidden="true"></i>示例<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">&quot; / &ldquo;请求将匹配配置A， &quot; /index.html &ldquo;请求将匹配配置B， &quot; /documents/document.html &ldquo;请求将匹配配置C， &quot; /images/1.gif &ldquo;请求将匹配配置D， &quot; /documents/1.jpg &ldquo;请求将匹配配置E。</div>
        </div>
    </div>
<h2 id="nginx-场景方案">Nginx 场景方案</h2>
<h3 id="nginx-配置动静分离">Nginx 配置动静分离</h3>
<h4 id="什么是动静分离">什么是动静分离</h4>
<ul>
<li>在 Web 开发中，通常来说，动态资源其实就是指那些后台资源，而静态资源就是指 HTML，JavaScript，CSS，img 等文件。</li>
<li>在使用前后端分离之后，可以很大程度的提升静态资源的访问速度，同时在开发过程中也可以让前后端开发并行可以有效的提高开发时间，也可以有效的减少联调时间 。</li>
<li>适合中小型网址</li>
</ul>
<h4 id="动静分离方案">动静分离方案</h4>
<ul>
<li>直接使用不同的域名，把静态资源放在独立的云服务器上，这个种方案也是目前比较推崇的。</li>
<li>动态请求和静态文件放在一起，通过 nginx 配置分开</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">server {
</span></span><span class="line"><span class="cl">  location /www/ {
</span></span><span class="line"><span class="cl">      root /www/;
</span></span><span class="line"><span class="cl">    index index.html index.htm;
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  location /image/ {
</span></span><span class="line"><span class="cl">      root /image/;
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="nginx-配置反向代理">nginx 配置反向代理</h3>
<p>反向代理常用于不想把端口暴露出去，直接访问域名处理请求。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">server {
</span></span><span class="line"><span class="cl">    listen    80;
</span></span><span class="line"><span class="cl">    server_name blog.dazhongma.top;
</span></span><span class="line"><span class="cl">    location /swoole/ {
</span></span><span class="line"><span class="cl">        proxy_pass http://127.0.0.1:9501;
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    location /node/ {
</span></span><span class="line"><span class="cl">        proxy_pass http://127.0.0.1:9502;
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="nginx-负载均衡配置">Nginx 负载均衡配置</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 定义一个名为phpServer的上游服务器组，用于负载均衡
</span></span><span class="line"><span class="cl">upstream phpServer{
</span></span><span class="line"><span class="cl">    # 指定上游服务器组中的服务器列表和端口
</span></span><span class="line"><span class="cl">    server 127.0.0.1:9501;  # 服务器1的地址和端口
</span></span><span class="line"><span class="cl">    server 127.0.0.1:9502;  # 服务器2的地址和端口
</span></span><span class="line"><span class="cl">    server 127.0.0.1:9503;  # 服务器3的地址和端口
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 定义一个服务器块，用于处理HTTP请求
</span></span><span class="line"><span class="cl">server {
</span></span><span class="line"><span class="cl">    # 监听80端口，即HTTP默认端口
</span></span><span class="line"><span class="cl">    listen 80;
</span></span><span class="line"><span class="cl">    # 设置服务器的域名
</span></span><span class="line"><span class="cl">    server_name blog.dazhongma.top;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # 定义对根目录的请求的处理方式
</span></span><span class="line"><span class="cl">    location / {
</span></span><span class="line"><span class="cl">        # 将请求代理到上游服务器组phpServer
</span></span><span class="line"><span class="cl">        proxy_pass http://phpServer;
</span></span><span class="line"><span class="cl">        # 关闭代理中的重定向
</span></span><span class="line"><span class="cl">        proxy_redirect off;
</span></span><span class="line"><span class="cl">        # 设置代理请求中的Host头，使用原始请求的Host头
</span></span><span class="line"><span class="cl">        proxy_set_header Host $host;
</span></span><span class="line"><span class="cl">        # 设置代理请求中的X-Real-IP头，使用原始请求的IP地址
</span></span><span class="line"><span class="cl">        proxy_set_header X-Real-IP $remote_addr;
</span></span><span class="line"><span class="cl">        # 设置当代理请求失败时，如何进行下一步操作
</span></span><span class="line"><span class="cl">        proxy_next_upstream error timeout invalid_header;
</span></span><span class="line"><span class="cl">        # 设置代理请求时，临时文件的最大大小为0，即不使用临时文件
</span></span><span class="line"><span class="cl">        proxy_max_temp_file_size 0;
</span></span><span class="line"><span class="cl">        # 设置代理连接的超时时间
</span></span><span class="line"><span class="cl">        proxy_connect_timeout 90;
</span></span><span class="line"><span class="cl">        # 设置代理发送请求的超时时间
</span></span><span class="line"><span class="cl">        proxy_send_timeout 90;
</span></span><span class="line"><span class="cl">        # 设置代理读取响应的超时时间
</span></span><span class="line"><span class="cl">        proxy_read_timeout 90;
</span></span><span class="line"><span class="cl">        # 设置代理使用的缓冲区大小
</span></span><span class="line"><span class="cl">        proxy_buffer_size 4k;
</span></span><span class="line"><span class="cl">        # 设置代理使用的缓冲区数量和大小
</span></span><span class="line"><span class="cl">        proxy_buffers 4 32k;
</span></span><span class="line"><span class="cl">        # 设置代理忙碌时使用的缓冲区大小
</span></span><span class="line"><span class="cl">        proxy_busy_buffers_size 64k;
</span></span><span class="line"><span class="cl">        # 设置代理临时文件写入的最大大小
</span></span><span class="line"><span class="cl">        proxy_temp_file_write_size 64k;
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="常用负载均衡策略">常用负载均衡策略</h4>
<p><strong>round-robin / 轮询</strong>： 到应用服务器的请求以 round-robin / 轮询的方式被分发</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">upstream phpServer{
</span></span><span class="line"><span class="cl">    server 127.0.0.1:9501 weight=3;
</span></span><span class="line"><span class="cl">    server 127.0.0.1:9502;
</span></span><span class="line"><span class="cl">    server 127.0.0.1:9503;
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在这个配置中，每 5 个新请求将会如下的在应用实例中分派： 3 个请求分派去 9501, 一个去 9502, 另外一个去 9503.</p>
<p><strong>least-connected / 最少连接</strong>：下一个请求将被分派到活动连接数量最少的服务器</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">upstream phpServer{
</span></span><span class="line"><span class="cl">    least_conn;
</span></span><span class="line"><span class="cl">    server 127.0.0.1:9501;
</span></span><span class="line"><span class="cl">    server 127.0.0.1:9502;
</span></span><span class="line"><span class="cl">    server 127.0.0.1:9503;
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>当某些请求需要更长时间来完成时，最少连接可以更公平的控制应用实例上的负载。</p>
<p><strong>ip-hash/IP 散列</strong>： 使用 hash 算法来决定下一个请求要选择哪个服务器 (基于客户端 IP 地址)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">upstream phpServer{
</span></span><span class="line"><span class="cl">    ip_hash;
</span></span><span class="line"><span class="cl">    server 127.0.0.1:9501;
</span></span><span class="line"><span class="cl">    server 127.0.0.1:9502;
</span></span><span class="line"><span class="cl">    server 127.0.0.1:9503;
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>将一个客户端绑定给某个特定的应用服务器；</p>
<h3 id="nginx-配置跨域">Nginx 配置跨域</h3>
<p>由于浏览器同源策略的存在使得一个源中加载来自其它源中资源的行为受到了限制。即会出现跨域请求禁止。
所谓同源是指：域名、协议、端口相同。</p>
<table>
<thead>
<tr>
<th>URL</th>
<th>结果</th>
<th>原因</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="http://blog.dazhongma.top/other/index.html" target="_blank" rel="noopener noreffer ">http://blog.dazhongma.top/other/index.html</a></td>
<td>成功</td>
<td>域名、协议、端口均 相同</td>
</tr>
<tr>
<td><a href="https://blog.dazhongma.top/home/index.html" target="_blank" rel="noopener noreffer ">https://blog.dazhongma.top/home/index.html</a></td>
<td>失败</td>
<td>协议不同</td>
</tr>
<tr>
<td><a href="http://blog.dazhongma.top:8080/home/index.html" target="_blank" rel="noopener noreffer ">http://blog.dazhongma.top:8080/home/index.html</a></td>
<td>失败</td>
<td>端口不同</td>
</tr>
<tr>
<td><a href="http://www.dazhongma.com/home/index.html" target="_blank" rel="noopener noreffer ">http://www.dazhongma.com/home/index.html</a></td>
<td>失败</td>
<td>域名不同</td>
</tr>
</tbody>
</table>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">server {
</span></span><span class="line"><span class="cl">        listen       80;
</span></span><span class="line"><span class="cl">        server_name  blog.dazhongma.top;
</span></span><span class="line"><span class="cl">        root   /Users/shiwenyuan/blog/public;
</span></span><span class="line"><span class="cl">        index  index.html index.htm index.php;
</span></span><span class="line"><span class="cl">        location / {
</span></span><span class="line"><span class="cl">            try_files $uri $uri/ /index.php?$query_string;
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">        add_header &#39;Access-Control-Allow-Origin&#39; &#34;$http_origin&#34;;
</span></span><span class="line"><span class="cl">        add_header &#39;Access-Control-Allow-Credentials&#39; &#39;true&#39;;
</span></span><span class="line"><span class="cl">        add_header &#39;Access-Control-Allow-Methods&#39; &#39;GET, POST, OPTIONS, DELETE, PUT, PATCH&#39;;
</span></span><span class="line"><span class="cl">        add_header &#39;Access-Control-Allow-Headers&#39; &#39;DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,X-XSRF-TOKEN&#39;;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        location ~ \.php$ {
</span></span><span class="line"><span class="cl">            fastcgi_pass   127.0.0.1:9000;
</span></span><span class="line"><span class="cl">            fastcgi_index  index.php;
</span></span><span class="line"><span class="cl">            fastcgi_param  SCRIPT_FILENAME $document_root$fastcgi_script_name;
</span></span><span class="line"><span class="cl">            include        fastcgi_params;
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">        error_page  404              /404.html;
</span></span><span class="line"><span class="cl">        error_page   500 502 503 504  /50x.html;
</span></span><span class="line"><span class="cl">        location = /50x.html {
</span></span><span class="line"><span class="cl">            root   html;
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Access-Control-Allow-Origin：允许的域名，只能填 *（通配符）或者单域名。</li>
<li>Access-Control-Allow-Methods: 允许的方法，多个方法以逗号分隔。</li>
<li>Access-Control-Allow-Headers: 允许的头部，多个方法以逗号分隔。</li>
<li>Access-Control-Allow-Credentials: 是否允许发送 Cookie。</li>
</ul>
<h3 id="urlrewrite-伪静态配置">URLRewrite 伪静态配置</h3>
<p>能隐藏后端服务器的地址</p>
<ul>
<li>URLRewrite的使用场景</li>
<li>配置方式</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">http://192.168.143.101/index.jsp?pageNum=2
</span></span><span class="line"><span class="cl">伪静态配置后，隐藏请求参数
</span></span><span class="line"><span class="cl">http://192.168.143.101/2.html
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">rewrite &lt;regex&gt; &lt;replacement&gt; [flag];
</span></span><span class="line"><span class="cl">关键字   正则       替代内容      flag标记
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">rewrite 参数的标签段位置：server,location,if
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">flag标记说明：
</span></span><span class="line"><span class="cl">last # 本条规则匹配完成后，继续向下匹配新的location URI规则
</span></span><span class="line"><span class="cl">break # 本条规则匹配完成即终止，不再匹配后面的任何规则
</span></span><span class="line"><span class="cl">redirect # 返回302 临时重定向，浏览器地址会显示跳转后的URL地址
</span></span><span class="line"><span class="cl">permant # 301 永久重定向，浏览器地址会显示跳转后的URL地址
</span></span></code></pre></td></tr></table>
</div>
</div><p>配置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">location / {
</span></span><span class="line"><span class="cl">	# ([0-9]+) 入参，$1 是 ([0-9]+)的占位符
</span></span><span class="line"><span class="cl">	rewrite ^/([0-9]+).html$  /index.jsp?pageNum=$1 break;
</span></span><span class="line"><span class="cl">	proxy_pass http://192.168.143.104:8080;
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="配置防盗链">配置防盗链</h3>
<p>防盗链本质上是存在自己服务器上的资源，只能由自己的服务器来访问，其实更多的时候网站还是希望自己的能够有更多的流量进来，而不是添加防盗链防止别人引用，只是在个别的情况，例如微信公众号文章中的图片不允许别人引用时会添加防盗链</p>
<ul>
<li>http协议中的referer</li>
<li>nginx 防盗链配置</li>
<li>使用浏览器或curl检测</li>
<li>返回错误码</li>
<li>返回错误页面</li>
<li>整合rewrite 返回报错图片</li>
</ul>
<p>防盗链配置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">valid_referes none | blocked |server_names | strings ...;
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>none，检测referer 头域不存在的情况</li>
<li>blocked,检测referer头域的值被防火墙或者代理服务器删除或伪装的情况。这种情况头域的值不以&quot;http://&quot; 或 &ldquo;https://&rdquo; 开头</li>
<li>server_names,设置一个或多个URL，检测Referer头域的值是否是这些URL中的某一个</li>
</ul>
<p>配置示例</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">location ~*/(js|img|css) {
</span></span><span class="line"><span class="cl">	# 检测来源的网址，而不是ip
</span></span><span class="line"><span class="cl">	valid_referes 192.168.44.101;
</span></span><span class="line"><span class="cl">	if($valid_referer){
</span></span><span class="line"><span class="cl">		return 403
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">	root html;
</span></span><span class="line"><span class="cl">	index index.html index.htm;
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>防盗链返回页面配置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 防盗链返回页面配置
</span></span><span class="line"><span class="cl">error_page 401 /401.html;
</span></span><span class="line"><span class="cl">    location = /401.html {
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">error_page 404 /404.html;
</span></span><span class="line"><span class="cl">    location = /404.html {
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">error_page 500 502 503 504 /50x.html;
</span></span><span class="line"><span class="cl">    location = /50x.html {
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="nginx-高可用配置">Nginx 高可用配置</h3>
<ul>
<li>高可用场景及解决方案</li>
<li>安装keepalived</li>
<li>选举方式(优先级配置)</li>
<li>示例节点<code>192.168.143.101</code>和<code>192.168.143.102</code>,vip <code>192.168.143.100</code>
安装</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 安装依赖
</span></span><span class="line"><span class="cl">$ yum install openssl-devel
</span></span><span class="line"><span class="cl">$ yum install keepalived
</span></span><span class="line"><span class="cl">$ vim /etc/keepalived/keepalived.conf
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>192.168.143.101</code> master 节点keepalived配置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">! Configuration File for keepalived
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">global_defs {
</span></span><span class="line"><span class="cl">   router_id LVS_DEVEL-101
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">vrrp_instance demo_keepalived {
</span></span><span class="line"><span class="cl">    state MASTER
</span></span><span class="line"><span class="cl">    # 注意修改网卡信息
</span></span><span class="line"><span class="cl">    interface ens33
</span></span><span class="line"><span class="cl">    virtual_router_id 51
</span></span><span class="line"><span class="cl">    priority 100
</span></span><span class="line"><span class="cl">    advert_int 1
</span></span><span class="line"><span class="cl">    authentication {
</span></span><span class="line"><span class="cl">        auth_type PASS
</span></span><span class="line"><span class="cl">        auth_pass 1111
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    virtual_ipaddress {
</span></span><span class="line"><span class="cl">        192.168.143.100
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>192.168.143.102</code> backup 节点keepalived配置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">! Configuration File for keepalived
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">global_defs {
</span></span><span class="line"><span class="cl">   router_id LVS_DEVEL-102
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">vrrp_instance demo_keepalived {
</span></span><span class="line"><span class="cl">    state BACKUP
</span></span><span class="line"><span class="cl">    # 注意修改网卡信息
</span></span><span class="line"><span class="cl">    interface ens32
</span></span><span class="line"><span class="cl">    virtual_router_id 51
</span></span><span class="line"><span class="cl">    priority 50
</span></span><span class="line"><span class="cl">    advert_int 1
</span></span><span class="line"><span class="cl">    authentication {
</span></span><span class="line"><span class="cl">        auth_type PASS
</span></span><span class="line"><span class="cl">        auth_pass 1111
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    virtual_ipaddress {
</span></span><span class="line"><span class="cl">        192.168.143.100
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="nginx-https-加密认证访问">Nginx https 加密认证访问</h3>
<h4 id="https-证书配置">https 证书配置</h4>
<ul>
<li>https原理</li>
<li>CA 机构</li>
<li>证书</li>
<li>客户端(浏览器)</li>
<li>服务器端</li>
<li>证书自签名</li>
<li>在线证书申请</li>
</ul>
<h4 id="证书自签名">证书自签名</h4>
<p>一般是用在内网中，通过openssl进行创建，对于公网还是需要进行申请购买的</p>
<p>生产nginx 自签名证书</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 命名时作区分使用(个人习惯)
</span></span><span class="line"><span class="cl">$ host_ip=192.168.143.101
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 1、模拟创建CA server_${host_ip}.key 私钥 ： 生成key：（生成rsa私钥，des3对称加密算法，openssl格式，2048位强度）
</span></span><span class="line"><span class="cl"># You must type in 4 to 1023 characters 使用 host_ip 地址即可
</span></span><span class="line"><span class="cl">$ openssl genrsa -des3 -out server_${host_ip}.key 2048
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 2、通过以下方法生成没有密码的key
</span></span><span class="line"><span class="cl">$ openssl rsa -in server_${host_ip}.key -out server_${host_ip}.key
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 3、[私钥加密]通过 CA server_${host_ip}.key 私钥钥生成自签名的 CA ca.crt 证书，该证书包含CA机构的公钥：（用来签署下面的server.csr文件,一路回车
</span></span><span class="line"><span class="cl">$ openssl req -new -x509 -key server_${host_ip}.key -out ca.crt -days 3650
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 4、生成证书签名csr请求 certificate sign request，包含1）公钥 2）申请者信息 3）域名, ：一路回车
</span></span><span class="line"><span class="cl">$ openssl req -new -key server_${host_ip}.key -out server.csr
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 5、[公钥验签(签名)] 将csr证书签名请求发送给CA机构，CA机构中对 ca.crt 证书进行签名处理并生成crt server_${host_ip}.crt：
</span></span><span class="line"><span class="cl"># 也就是说公钥 server_${host_ip}.crt 相对于 公钥 ca.crt多了签名处理的
</span></span><span class="line"><span class="cl">$ openssl x509 -req -days 3650 -in server.csr -CA ca.crt -CAkey server_${host_ip}.key -CAcreateserial -out server_${host_ip}.crt
</span></span></code></pre></td></tr></table>
</div>
</div><p>总结：</p>
<ol>
<li>生成私钥<code>server_${host_ip}.key</code></li>
<li>生成没有密码的私钥key(可选)</li>
<li>自签名的 CA ca.crt 证书，该证书包含CA机构的公钥</li>
<li>生成证书签名csr请求(CSR)</li>
<li>公钥验签(签名)</li>
<li>验证证书</li>
</ol>
<ul>
<li><a href="https://hohnstaedt.de/xca/" target="_blank" rel="noopener noreffer ">图形化工具XCA</a></li>
</ul>
<h3 id="nginx-开启http并重定向到https">Nginx 开启http并重定向到https</h3>
<h4 id="开启http">开启http</h4>
<p>开启http很简单，直接把listen 80;加到listen 443 ssl;上面去就可以了。或者新加一个server配置，如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">server {
</span></span><span class="line"><span class="cl">    listen 443 ssl;
</span></span><span class="line"><span class="cl">    server_name localhost;
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    ssl_certificate /key-path/localhost.pem;
</span></span><span class="line"><span class="cl">    ssl_certificate_key /key-path/localhost.key;
</span></span><span class="line"><span class="cl">    ssl_session_timeout 5m;
</span></span><span class="line"><span class="cl">    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;  
</span></span><span class="line"><span class="cl">    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
</span></span><span class="line"><span class="cl">    ssl_prefer_server_ciphers on; 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    location / {
</span></span><span class="line"><span class="cl">        proxy_set_header HOST $host;
</span></span><span class="line"><span class="cl">        proxy_set_header X-Forwarded-Proto $scheme;
</span></span><span class="line"><span class="cl">        proxy_set_header X-Real-IP $remote_addr;
</span></span><span class="line"><span class="cl">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        proxy_pass http://127.0.0.1:8000/;
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">server {
</span></span><span class="line"><span class="cl">    listen 80;
</span></span><span class="line"><span class="cl">    server_name localhost;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    location / {
</span></span><span class="line"><span class="cl">        proxy_set_header HOST $host;
</span></span><span class="line"><span class="cl">        proxy_set_header X-Forwarded-Proto $scheme;
</span></span><span class="line"><span class="cl">        proxy_set_header X-Real-IP $remote_addr;
</span></span><span class="line"><span class="cl">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        proxy_pass http://127.0.0.1:8000/;
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="重定向到https的两种方式">重定向到https的两种方式</h4>
<p>要把http重定向到https也很简单，具体可以使用两种配置来实现。</p>
<p>第一种方式使用return 301如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">server {
</span></span><span class="line"><span class="cl">    listen 80;
</span></span><span class="line"><span class="cl">    server_name localhost;
</span></span><span class="line"><span class="cl">    return 301 https://127.0.0.1$request_uri;
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>第二种方式使用rewrite如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">server {
</span></span><span class="line"><span class="cl">    listen 80;
</span></span><span class="line"><span class="cl">    server_name localhost;
</span></span><span class="line"><span class="cl">    rewrite ^(.*)$ https://$host$1 permanent;
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>对于return和rewrite的区别，可以阅读这篇文章：<a href="https://blog.nginx.org/blog/creating-nginx-rewrite-rules" target="_blank" rel="noopener noreffer ">Creating NGINX Rewrite Rules</a></p>
<h3 id="nginx-对客户端和上游服务器使用keepalive-配置详解">nginx 对客户端和上游服务器使用keepalive 配置详解</h3>
<p>Nginx 中的 keepalive 是一种机制，用于在客户端和服务器之间保持连接的活跃状态，从而避免每次请求都需要重新建立 TCP 连接所带来的开销。这可以显著提高性能，尤其是在高延迟网络环境中。以下是对 Nginx 配置 keepalive 的详细介绍。</p>
<h4 id="1-http-keepalive">1. HTTP Keepalive</h4>
<p>对于 HTTP 协议，可以通过以下指令来配置 keepalive：</p>
<ul>
<li>
<p><strong>keepalive_timeout</strong>：设置 keep-alive 客户端连接在服务器端保持打开状态的时间长度。例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="k">keepalive_timeout</span> <span class="mi">65</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面的例子表示如果一个连接在65秒内没有活动，那么它将被关闭。</p>
</li>
<li>
<p><strong>keepalive_requests</strong>：指定一个 keep-alive 连接上可以服务的最大请求数量。默认情况下这个值是100。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="k">keepalive_requests</span> <span class="mi">100</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><strong>keepalive_disable</strong>：允许禁用对某些浏览器的支持。一些旧版浏览器可能无法正确处理 keep-alive 请求。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="k">keepalive_disable</span> <span class="s">msie6</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="2-upstream-keepalive">2. Upstream Keepalive</h3>
<p>nginx 对上游服务器使用keepalive 配置详解</p>
<p>当与上游服务器（如应用服务器）通信时，也可以使用 keepalive 来优化连接。这需要通过 <code>upstream</code> 块进行配置，并且需要使用 <code>keepalive</code> 指令来指定要缓存的空闲 keepalive 连接数。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="k">upstream</span> <span class="s">backend</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">server</span> <span class="s">backend1.example.com</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">server</span> <span class="s">backend2.example.com</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">keepalive</span> <span class="mi">32</span><span class="p">;</span> <span class="c1"># 设置保持连接的空闲连接数为32
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kn">keepalive_requests</span> <span class="mi">1000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">keepalive_timeout</span> <span class="mi">65</span><span class="p">;</span> <span class="c1"># 可以不配，直接使用默认
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">server</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kn">proxy_pass</span> <span class="s">http://backend</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">proxy_http_version</span> <span class="mi">1</span><span class="s">.1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">proxy_set_header</span> <span class="s">Connection</span> <span class="s">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里需要注意的是，为了使 upstream keepalive 起作用，必须将 <code>proxy_http_version</code> 设置为 <code>1.1</code> 并清除 <code>Connection</code> 头部字段。</p>
<h4 id="注意事项">注意事项</h4>
<ul>
<li>使用 keepalive 可能会增加服务器资源的消耗，因为它需要维护更多的连接状态。因此，合理设置 keepalive 相关参数是非常重要的。</li>
<li>对于 HTTPS 站点，除了上述配置外，还需要考虑 SSL/TLS 握手的成本。尽管 keepalive 可以重用已建立的安全连接，减少重复握手带来的延迟，但是首次连接仍需完成完整的 SSL/TLS 握手过程。</li>
</ul>
<p>通过适当的配置，Nginx 的 keepalive 功能可以帮助提升网站或应用的响应速度和整体性能。</p>
<h3 id="nginx-内存与文件缓冲区">Nginx 内存与文件缓冲区</h3>
<p>Nginx 作为一款高性能的HTTP和反向代理服务器，其处理请求的能力很大程度上依赖于其对内存和文件缓冲区的有效管理。下面介绍Nginx反向代理的内存与文件缓冲区的核心流程。</p>
<h4 id="header-缓冲区">Header 缓冲区</h4>
<ul>
<li><strong>proxy_buffer_size</strong>：这个指令用于设置读取来自后端服务器响应的第一部分（通常包括响应头）的缓冲区大小。由于响应头可能包含一些较大的Cookie或其它元数据，适当调整这个值可以确保头部信息能够被完整地缓存而不会导致额外的磁盘I/O操作。</li>
</ul>
<h4 id="body-缓冲区">Body 缓冲区</h4>
<ul>
<li>
<p><strong>proxy_buffering on;</strong>：启用或禁用缓冲功能。当开启时，Nginx会尝试先将从上游服务器接收到的数据存储到由<code>proxy_buffers</code>指定的内存缓冲区中。如果响应数据量超过了内存缓冲区容量，则超出部分会被写入由<code>proxy_temp_path</code>定义的临时文件中。若关闭(<code>off</code>)，则所有响应内容都将直接发送给客户端，而不经过任何缓冲，这可能会增加客户端等待时间并减少服务器性能。</p>
</li>
<li>
<p><strong>proxy_buffers 32 64k;</strong>：此指令定义了用于存储响应体的缓冲区数量及其大小。在这个例子中，它表示分配了32个每个大小为64KB的缓冲块来保存响应体数据。合理的配置可以根据预期的响应体大小及系统资源状况进行调整，以优化性能。</p>
</li>
<li>
<p><strong>proxy_max_temp_file_size 1G;</strong>：当响应体过大以至于超过内存缓冲区容量时，Nginx会将多余的数据写入临时文件。该参数限制了这些临时文件的最大总尺寸，默认情况下是1GB。如果达到这个限制，Nginx将停止向磁盘写入新的数据，并开始直接将剩余的响应流式传输给客户端。</p>
</li>
<li>
<p><strong>proxy_temp_file_write_size 8k;</strong>：控制一次写入临时文件的数据量。这里的例子表明每次写操作的大小被设定为8KB。合理设置这个值有助于平衡磁盘I/O负载，尤其是在处理大量并发请求时尤为重要。</p>
</li>
</ul>
<p>通过上述配置，Nginx能有效地管理反向代理过程中的数据流动，既保证了快速响应又能有效利用服务器资源。需要注意的是，实际应用中应根据具体情况（如服务器硬件条件、预计的流量规模等）调整这些参数，以实现最佳性能。</p>
<p><strong>示例</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">http {
</span></span><span class="line"><span class="cl">    # 其他配置项...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    server {
</span></span><span class="line"><span class="cl">        listen 80;
</span></span><span class="line"><span class="cl">        server_name example.com;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        location / {
</span></span><span class="line"><span class="cl">            proxy_pass http://backend_server; # 假设后端服务器地址
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            # 设置Header缓冲区大小
</span></span><span class="line"><span class="cl">            proxy_buffer_size 128k;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            # 启用响应体数据的缓冲功能
</span></span><span class="line"><span class="cl">            proxy_buffering on;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            # 设置用于读取响应体的缓冲区数量和大小
</span></span><span class="line"><span class="cl">            proxy_buffers 32 64k;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            # 当响应体过大时，限制写入磁盘的临时文件的最大总尺寸为1G
</span></span><span class="line"><span class="cl">            proxy_max_temp_file_size 1G;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            # 控制一次写入临时文件的数据量为8KB
</span></span><span class="line"><span class="cl">            proxy_temp_file_write_size 8k;
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # 定义上游服务器组
</span></span><span class="line"><span class="cl">    upstream backend_server {
</span></span><span class="line"><span class="cl">        server 192.168.1.1:8080; # 后端服务器的实际IP和端口
</span></span><span class="line"><span class="cl">        server 192.168.1.2:8080; # 可以添加多个后端服务器进行负载均衡
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>配置解释：</p>
<ul>
<li><code>proxy_buffer_size 128k;</code>：增大了header部分的缓冲区大小到128KB，适用于包含较大头部信息的情况。</li>
<li><code>proxy_buffering on;</code>：启用缓冲功能。这意味着Nginx会尝试先将从后端服务器接收到的数据存储在内存中，而不是直接传递给客户端。</li>
<li><code>proxy_buffers 32 64k;</code>：设置了32块每块64KB大小的缓冲区来存储响应体内容。这样总共提供了2MB（32*64KB）的内存空间来缓存响应体数据。</li>
<li><code>proxy_max_temp_file_size 1G;</code>：当响应体太大以至于超过内存缓冲区容量时，Nginx会将超出的数据写入磁盘上的临时文件，此设置限制了这些临时文件的最大总尺寸为1GB。</li>
<li><code>proxy_temp_file_write_size 8k;</code>：控制了一次写入磁盘临时文件的数据量为8KB，有助于平衡磁盘I/O操作。</li>
</ul>
<p>这个配置实例展示了如何使用上述参数来优化Nginx作为反向代理时的性能表现。根据实际情况，比如后端服务响应的数据量、服务器硬件资源等，你可以适当调整这些数值以达到最佳效果。</p>
<h3 id="nginx-对客户端的限制">Nginx 对客户端的限制</h3>
<p>Nginx 提供了多种配置选项来限制客户端请求，包括对请求体大小、头部大小、超时时间等方面的控制。以下是对你提到的关键词进行补充并给出完整释义，以及一个配置示例。</p>
<h4 id="关键词解释">关键词解释</h4>
<ul>
<li>
<p><strong>client_body_buffer_size</strong>：设置用于读取客户端请求体（body）的缓冲区大小。如果请求体超过了这个缓冲区大小，数据将被写入磁盘上的临时文件。这对于处理大文件上传等场景非常重要。</p>
</li>
<li>
<p><strong>client_header_buffer_size</strong>：设置用于读取客户端请求头（header）的缓冲区大小。大多数情况下，默认值足以满足需求，但如果客户端发送非常大的请求头（如包含大量Cookie或长URL），则可能需要增加此值。</p>
</li>
<li>
<p><strong>client_body_temp_path</strong>：指定当请求体超过<code>client_body_buffer_size</code>时，Nginx将请求体数据写入磁盘的临时文件存储路径。合理设置可以避免系统默认临时目录空间不足的问题。</p>
</li>
<li>
<p><strong>client_max_body_size 1000M;</strong>：定义允许客户端请求的最大主体大小。如果请求体超过这个值，Nginx会返回413 (Request Entity Too Large)错误。设置为0可禁用检查。</p>
</li>
<li>
<p><strong>client_body_timeout</strong>：设置等待客户端发送请求体的超时时间。如果在设定的时间内没有收到完整的请求体，Nginx将关闭连接。</p>
</li>
<li>
<p><strong>client_header_timeout</strong>：设置等待客户端发送请求头的超时时间。如果在这个时间内没有收到完整的请求头，Nginx也将关闭连接。</p>
</li>
</ul>
<h4 id="配置示例">配置示例</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="k">http</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 设置客户端请求体的缓冲区大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kn">client_body_buffer_size</span> <span class="mi">16k</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 设置客户端请求头的缓冲区大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kn">client_header_buffer_size</span> <span class="mi">2k</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 设置当请求体过大时，Nginx写入磁盘的临时文件存储位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kn">client_body_temp_path</span> <span class="s">/var/lib/nginx/body</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 允许客户端请求的最大主体大小为1000MB
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kn">client_max_body_size</span> <span class="s">1000M</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 如果在60秒内没有读取到请求体，就报超时错误
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kn">client_body_timeout</span> <span class="s">60s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 如果在30秒内没有读取到请求头，就报超时错误
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kn">client_header_timeout</span> <span class="s">30s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kn">server</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">server_name</span> <span class="s">example.com</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kn">proxy_pass</span> <span class="s">http://backend_server</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kn">upstream</span> <span class="s">backend_server</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kn">server</span> <span class="n">192.168.1.1</span><span class="p">:</span><span class="mi">8080</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">server</span> <span class="n">192.168.1.2</span><span class="p">:</span><span class="mi">8080</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="补充说明">补充说明</h4>
<ul>
<li>对于处理大文件上传的场景，除了调整<code>client_body_buffer_size</code>和<code>client_max_body_size</code>外，还需要确保服务器有足够的磁盘空间来存放临时文件，并且正确设置了<code>client_body_temp_path</code>。</li>
<li><code>client_body_timeout</code>和<code>client_header_timeout</code>可以根据实际网络状况和应用需求进行调整，以平衡性能和用户体验。</li>
<li>考虑安全性，建议根据实际情况合理设置<code>client_max_body_size</code>，防止因过大的请求导致服务器资源耗尽。</li>
</ul>
<h3 id="nginx-gzip压缩">Nginx Gzip压缩</h3>
<p>使用示例</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">http {
</span></span><span class="line"><span class="cl">	...
</span></span><span class="line"><span class="cl">	# nginx 动态压缩 和 静态压缩结合使用会更好
</span></span><span class="line"><span class="cl">    # 开启gzip 静态压缩
</span></span><span class="line"><span class="cl">    gzip_static  on;
</span></span><span class="line"><span class="cl">    # 作为反向代理时，针对上游服务器返回的头信息进行压缩
</span></span><span class="line"><span class="cl">    gzip_proxied expired no-cache no-store private auth;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # 开启gzip 动态压缩
</span></span><span class="line"><span class="cl">    gzip on;
</span></span><span class="line"><span class="cl">    # 启用gzip压缩的最小文件，小于设置值的文件将不会压缩
</span></span><span class="line"><span class="cl">    gzip_min_length 1k;
</span></span><span class="line"><span class="cl">    # gzip 压缩级别，1-9，数字越大压缩的越好，也越占用CPU时间，后面会有详细说明
</span></span><span class="line"><span class="cl">    gzip_comp_level 6;
</span></span><span class="line"><span class="cl">    # 进行压缩的文件类型。javascript有多种形式。其中的值可以在 mime.types 文件中找到。
</span></span><span class="line"><span class="cl">    gzip_types text/plain application/javascript application/x-javascript text/css application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png application/vnd.ms-fontobject font/ttf font/opentype font/x-woff image/svg+xml;
</span></span><span class="line"><span class="cl">    # 是否在http header中添加Vary: Accept-Encoding，建议开启，不配置也就可以
</span></span><span class="line"><span class="cl">    gzip_vary on;
</span></span><span class="line"><span class="cl">    # 禁用IE 1-6版本的 gzip压缩，大型网站建议不要配置，建议尽量不要在配置文件中出现正则表达式，少用正则，因为这是影响性能的一个选项
</span></span><span class="line"><span class="cl">    # gzip_disable &#34;MSIE [1-6]\.&#34;;
</span></span><span class="line"><span class="cl">    # 设置压缩所需要的缓冲区大小
</span></span><span class="line"><span class="cl">    gzip_buffers 32 4k;
</span></span><span class="line"><span class="cl">    # 设置gzip压缩针对的HTTP协议版本
</span></span><span class="line"><span class="cl">    gzip_http_version 1.0;
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl">    server {
</span></span><span class="line"><span class="cl">    	listen       80;
</span></span><span class="line"><span class="cl">        listen       [::]:80;
</span></span><span class="line"><span class="cl">        ...
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="gzip-动态压缩及缺点">Gzip 动态压缩及缺点</h4>
<p>缺点：开启gzip 压缩后，sendfile 零拷贝则会失效</p>
<h4 id="gzip-静态压缩">Gzip 静态压缩</h4>
<p>静态压缩开始不会导致sendfile 零拷贝失效</p>
<h3 id="nginx-配置正向代理与反向代理缓存">Nginx 配置正向代理与反向代理缓存</h3>
<p>正向代理配置参考</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ proxy_pass $scheme://$host$request_uri;
</span></span><span class="line"><span class="cl">$ resolver 8.8.8.8;
</span></span></code></pre></td></tr></table>
</div>
</div><p>反向代理缓存proxy_cache配置示例</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">http {
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">  upstream backend {
</span></span><span class="line"><span class="cl">	      keepalive 1000; 	# 设置最大空闲连接数为32
</span></span><span class="line"><span class="cl">        keepalive_requests 1000;
</span></span><span class="line"><span class="cl">        server 192.168.143.102;
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">proxy_cache_path /ngx_tmp levels=1:2 keys_zone=test_cache:100m inactive=1d max_size=10g;
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    server {
</span></span><span class="line"><span class="cl">          listen       80;
</span></span><span class="line"><span class="cl">          listen       [::]:80;
</span></span><span class="line"><span class="cl">          ....
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         location / {
</span></span><span class="line"><span class="cl">           proxy_pass http://backend;
</span></span><span class="line"><span class="cl">           proxy_http_version 1.1;
</span></span><span class="line"><span class="cl">           proxy_set_header Connection &#34;&#34;;
</span></span><span class="line"><span class="cl">		  # proxy 反向代理缓存
</span></span><span class="line"><span class="cl">           add_header Nginx-Cache &#34;$upstream_cache_status&#34;;
</span></span><span class="line"><span class="cl">           proxy_cache test_cache;
</span></span><span class="line"><span class="cl">           proxy_cache_valid 1h; # 到上游服务器取数据多久过期
</span></span><span class="line"><span class="cl">         }
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>nginx 反向代理缓存proxy_cache 配置的优点</p>
<p>Nginx的<code>proxy_cache</code>配置主要用于实现反向代理缓存，它有多个显著的好处，可以极大地提升Web应用的性能和可靠性：</p>
<h4 id="提高响应速度">提高响应速度</h4>
<ul>
<li><strong>减少后端服务器负载</strong>：通过缓存静态内容或频繁请求的数据，可以大幅减少后端服务器处理请求的次数，从而提高响应速度。</li>
<li><strong>快速响应用户请求</strong>：对于已经缓存的内容，Nginx可以直接从本地磁盘提供服务，而不需要转发到后端服务器进行处理，这大大加快了响应时间。</li>
</ul>
<h4 id="增强系统的可扩展性和稳定性">增强系统的可扩展性和稳定性</h4>
<ul>
<li><strong>平滑流量高峰</strong>：在流量高峰期，缓存可以减轻后端服务器的压力，避免因过载导致的服务中断或响应迟缓。</li>
<li><strong>提高可用性</strong>：即使后端服务器暂时不可用（例如由于维护或故障），Nginx也可以继续为用户提供缓存的内容，确保服务的连续性。</li>
</ul>
<h4 id="优化资源利用">优化资源利用</h4>
<ul>
<li><strong>节省带宽</strong>：缓存机制减少了重复数据传输的需求，有助于节省网络带宽。</li>
<li><strong>降低数据库压力</strong>：对于动态内容，如果部分数据可以被缓存（如查询结果），则可以减少对数据库的直接访问次数，降低数据库的压力。</li>
</ul>
<h4 id="灵活的配置选项">灵活的配置选项</h4>
<ul>
<li><strong>细粒度控制</strong>：Nginx提供了丰富的指令来控制缓存行为，比如设置缓存的有效期、如何更新缓存、哪些响应应该被缓存等。</li>
<li><strong>支持条件缓存</strong>：可以根据请求方法、响应头等多种条件决定是否缓存响应，使得缓存策略更加灵活和精确。</li>
</ul>
<h4 id="实现简单且高效">实现简单且高效</h4>
<ul>
<li><strong>易于部署和管理</strong>：与应用程序级别的缓存相比，Nginx的反向代理缓存配置相对简单，容易集成到现有架构中。</li>
<li><strong>高效的存储机制</strong>：Nginx采用高效的文件系统存储方式，并支持内存缓存以加速频繁访问的内容。</li>
</ul>
<p>合理地使用Nginx的<code>proxy_cache</code>不仅可以显著提升用户体验，还能增强整个系统的稳定性和效率。不过需要注意的是，缓存策略的设计应当考虑到数据的一致性和时效性要求，以免影响到用户的体验或业务逻辑的正确执行。</p>
<h3 id="nginx-配置带宽限制">Nginx 配置带宽限制</h3>
<p>Nginx 提供了多种方式来限制带宽，以满足不同的需求场景。这通常用于防止服务器过载、保障服务质量或控制内容分发速度等。下面是一些常见的使用场景以及相应的配置示例。</p>
<h4 id="场景一限制客户端下载速度">场景一：限制客户端下载速度</h4>
<p>在某些情况下，你可能希望限制客户端从你的网站下载文件的最大速度，以确保所有用户都能获得良好的服务体验，或者控制资源的使用情况。</p>
<p>示例配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="k">server</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">server_name</span> <span class="s">example.com</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kn">location</span> <span class="s">/downloads/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 使用的是令牌桶算法，限制下载速率为每秒100KB
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kn">limit_rate</span> <span class="mi">100k</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 可选：设置初始爆发速率，这里为500KB
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kn">limit_rate_after</span> <span class="mi">500k</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="kn">root</span> <span class="s">/var/www/downloads</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在这个例子中，<code>limit_rate</code> 指令设置了每个响应的最大传输速率（这里是100KB/s），而 <code>limit_rate_after</code> 则指定了在开始限速之前允许传输的数据量（这里是500KB）。这意味着对于前500KB的数据，不会有任何速率限制，之后的速度将被限制在100KB/s。</p>
<h4 id="场景二基于连接数和请求频率的流量控制">场景二：基于连接数和请求频率的流量控制</h4>
<p>有时，除了限制带宽外，还需要对来自单个IP地址的并发连接数或请求频率进行限制，以防止恶意攻击或滥用资源。</p>
<p>示例配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="k">http</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 定义一个名为 addr 的限流区，限制每秒请求数不超过20次
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kn">limit_req_zone</span> <span class="nv">$binary_remote_addr</span> <span class="s">zone=addr:10m</span> <span class="s">rate=20r/s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kn">server</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">server_name</span> <span class="s">example.com</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 应用前面定义的限流区，并允许突发最多5个额外请求
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kn">limit_req</span> <span class="s">zone=addr</span> <span class="s">burst=5</span> <span class="s">nodelay</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># 限制每个连接的带宽为50KB/s
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kn">limit_rate</span> <span class="mi">50k</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kn">proxy_pass</span> <span class="s">http://backend</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里使用了 <code>limit_req_zone</code> 和 <code>limit_req</code> 来限制每个IP地址的请求频率，同时通过 <code>limit_rate</code> 来限制带宽。这样可以有效地保护服务器免受过多请求的影响，同时也控制了数据传输速度。</p>
<h4 id="场景三针对不同用户组应用不同的带宽限制">场景三：针对不同用户组应用不同的带宽限制</h4>
<p>有时候需要根据用户的类型（如免费用户与付费用户）提供不同的服务级别，包括不同的下载速度。</p>
<p>示例配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="k">map</span> <span class="nv">$http_x_user_type</span> <span class="nv">$download_rate</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">default</span> <span class="s">&#34;50k&#34;</span><span class="p">;</span>  <span class="c1"># 默认下载速率为50KB/s
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kn">premium</span> <span class="s">&#34;200k&#34;</span><span class="p">;</span> <span class="c1"># 高级用户的下载速率为200KB/s
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">server</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">server_name</span> <span class="s">example.com</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kn">location</span> <span class="s">/downloads/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 根据用户类型动态设置下载速率
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kn">limit_rate</span> <span class="nv">$download_rate</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="kn">root</span> <span class="s">/var/www/downloads</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在这个配置中，我们使用了 <code>map</code> 指令根据自定义的HTTP头（本例中的 <code>X-User-Type</code>）来决定使用哪个下载速率。这使得可以根据用户的类别灵活地调整服务等级。</p>
<p>这些只是Nginx带宽限制的一些基础应用场景和配置示例。实际部署时，你可能需要根据具体的需求和环境进行适当的调整。</p>
<h3 id="nginx-并发数限制">Nginx 并发数限制</h3>
<p>Nginx 的并发限制功能主要用于控制来自单一客户端或一组客户端的连接数，以防止服务器过载或被滥用。通过使用 <code>limit_conn_zone</code> 和 <code>limit_conn</code> 指令，可以有效地管理资源并确保服务的稳定性。以下是几个常见的使用场景及相应的配置示例。</p>
<h4 id="场景一限制单个ip地址的最大并发连接数">场景一：限制单个IP地址的最大并发连接数</h4>
<p>在Web服务器上，可能会遇到某些用户同时发起大量请求的情况，这可能导致服务器资源耗尽，影响其他用户的访问体验。通过限制每个IP地址的最大并发连接数，可以有效缓解这种问题。</p>
<p>示例配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="k">http</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 定义一个名为 addr 的限流区，基于客户端的 IP 地址进行限制
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kn">limit_conn_zone</span> <span class="nv">$binary_remote_addr</span> <span class="s">zone=addr:10m</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kn">server</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">server_name</span> <span class="s">example.com</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 允许每个IP地址最多有10个并发连接
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kn">limit_conn</span> <span class="s">addr</span> <span class="mi">10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="kn">proxy_pass</span> <span class="s">http://backend</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在这个例子中，<code>limit_conn_zone</code> 使用 <code>$binary_remote_addr</code> 变量作为键（即客户端的IP地址），并在共享内存区域 <code>addr</code> 中保存状态信息，大小为10MB。然后，在具体的 <code>location</code> 块中使用 <code>limit_conn</code> 来指定每个IP地址允许的最大并发连接数为10。</p>
<h4 id="场景二根据不同的url路径应用不同的并发限制">场景二：根据不同的URL路径应用不同的并发限制</h4>
<p>有时需要对不同类型的资源应用不同的并发限制策略。例如，对于静态资源和动态内容可能希望设置不同的最大并发连接数。</p>
<p>示例配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="k">http</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 定义两个限流区，一个基于IP地址，另一个基于URI
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kn">limit_conn_zone</span> <span class="nv">$binary_remote_addr</span> <span class="s">zone=per_ip:10m</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">limit_conn_zone</span> <span class="nv">$request_uri</span> <span class="s">zone=per_uri:10m</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kn">server</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">server_name</span> <span class="s">example.com</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kn">location</span> <span class="s">/static/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 对于静态资源，限制每个IP地址最多有20个并发连接
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kn">limit_conn</span> <span class="s">per_ip</span> <span class="mi">20</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kn">location</span> <span class="s">/api/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 对于API请求，限制每个URI最多有5个并发连接
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kn">limit_conn</span> <span class="s">per_uri</span> <span class="mi">5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="kn">proxy_pass</span> <span class="s">http://backend_api</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>此配置为 <code>/static/</code> 路径下的请求设置了基于IP地址的并发限制，而为 <code>/api/</code> 路径下的请求设置了基于URI的并发限制。</p>
<h4 id="场景三结合速率限制与并发限制">场景三：结合速率限制与并发限制</h4>
<p>在一些高流量网站中，不仅需要限制并发连接数，还需要限制请求的速率，以进一步保护后端服务免受突发流量的影响。</p>
<p>示例配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="k">http</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 定义并发限制区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kn">limit_conn_zone</span> <span class="nv">$binary_remote_addr</span> <span class="s">zone=addr:10m</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 定义速率限制区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kn">limit_req_zone</span> <span class="nv">$binary_remote_addr</span> <span class="s">zone=req_limit_per_ip:10m</span> <span class="s">rate=5r/s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kn">server</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">server_name</span> <span class="s">example.com</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 设置每个IP地址最多有5个并发连接
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kn">limit_conn</span> <span class="s">addr</span> <span class="mi">5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># 设置每个IP地址每秒最多处理5个请求，并允许突发最多10个额外请求
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kn">limit_req</span> <span class="s">zone=req_limit_per_ip</span> <span class="s">burst=10</span> <span class="s">nodelay</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="kn">proxy_pass</span> <span class="s">http://backend</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这个例子展示了如何同时应用并发限制和速率限制来保护你的Web应用。通过这种方式，既可以控制同一时间内的最大连接数，也能平滑请求到达的速率，避免瞬间的大流量冲击。</p>
<p>以上是关于Nginx并发限制的一些典型应用场景及其配置示例。根据实际情况调整这些参数，可以帮助你更好地管理和优化你的Web服务性能。</p>
<h3 id="nginx-日志管理">Nginx 日志管理</h3>
<ul>
<li>应用场景</li>
<li>访问日志</li>
<li>错误日志</li>
<li>日志分隔</li>
</ul>
<p><a href="https://nginx.org/en/docs/http/ngx_http_log_module.html" target="_blank" rel="noopener noreffer ">ngx_http_log_module</a></p>
<h4 id="日志内存缓冲区">日志内存缓冲区</h4>
<p>包日志压缩解压缩与json格式输出样例</p>
<p>示例</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">http {
</span></span><span class="line"><span class="cl">    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &#34;$request&#34; &#39;
</span></span><span class="line"><span class="cl">                      &#39;$status $body_bytes_sent &#34;$http_referer&#34; &#39;
</span></span><span class="line"><span class="cl">                      &#39;&#34;$http_user_agent&#34; &#34;$http_x_forwarded_for&#34;&#39;;
</span></span><span class="line"><span class="cl">    # buffer=32k 当日志大小达到32k时会写入至指定的日志文件下
</span></span><span class="line"><span class="cl">    #  access_log  /var/log/nginx/access.log  main buffer=32k gzip=3 flush=1s;
</span></span><span class="line"><span class="cl">    access_log  /var/log/nginx/access.log  main buffer=32k;
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="json格式输出">json格式输出</h4>
<p>要在Nginx中配置日志格式为JSON输出，你需要定义一个自定义的日志格式，并使用<code>log_format</code>指令将其设置为JSON结构。以下是一个示例配置，展示了如何设置Nginx以JSON格式记录访问日志。</p>
<p>示例配置</p>
<p>首先，在你的Nginx配置文件（通常是<code>nginx.conf</code>或位于<code>sites-available</code>目录下的某个配置文件）中的<code>http</code>块内添加如下定义：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="k">http</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 定义JSON格式的日志
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kn">log_format</span> <span class="s">json_combined</span> <span class="s">escape=json</span> <span class="s">&#39;</span><span class="p">{</span><span class="kn">&#34;time_local&#34;:</span> <span class="s">&#34;</span><span class="nv">$time_local&#34;,</span> <span class="s">&#39;</span>
</span></span><span class="line"><span class="cl">                                     <span class="s">&#39;&#34;remote_addr&#34;:</span> <span class="s">&#34;</span><span class="nv">$remote_addr&#34;,</span> <span class="s">&#39;</span>
</span></span><span class="line"><span class="cl">                                     <span class="s">&#39;&#34;remote_user&#34;:</span> <span class="s">&#34;</span><span class="nv">$remote_user&#34;,</span> <span class="s">&#39;</span>
</span></span><span class="line"><span class="cl">                                     <span class="s">&#39;&#34;request&#34;:</span> <span class="s">&#34;</span><span class="nv">$request&#34;,</span> <span class="s">&#39;</span>
</span></span><span class="line"><span class="cl">                                     <span class="s">&#39;&#34;status&#34;:</span> <span class="nv">$status,</span> <span class="s">&#39;</span>
</span></span><span class="line"><span class="cl">                                     <span class="s">&#39;&#34;body_bytes_sent&#34;:</span> <span class="nv">$body_bytes_sent,</span> <span class="s">&#39;</span>
</span></span><span class="line"><span class="cl">                                     <span class="s">&#39;&#34;request_time&#34;:</span> <span class="nv">$request_time,</span> <span class="s">&#39;</span>
</span></span><span class="line"><span class="cl">                                     <span class="s">&#39;&#34;http_referer&#34;:</span> <span class="s">&#34;</span><span class="nv">$http_referer&#34;,</span> <span class="s">&#39;</span>
</span></span><span class="line"><span class="cl">                                     <span class="s">&#39;&#34;http_user_agent&#34;:</span> <span class="s">&#34;</span><span class="nv">$http_user_agent&#34;}&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kn">server</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">server_name</span> <span class="s">example.com</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kn">access_log</span> <span class="s">/var/log/nginx/access.log</span> <span class="s">json_combined</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kn">proxy_pass</span> <span class="s">http://backend</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>释义</strong></p>
<ul>
<li><strong>log_format</strong>：这里我们定义了一个名为<code>json_combined</code>的日志格式。使用<code>escape=json</code>确保所有特殊字符都被正确转义，避免破坏JSON结构。</li>
<li><strong>字段说明</strong>：
<ul>
<li><code>$time_local</code>: 请求的本地时间。</li>
<li><code>$remote_addr</code>: 客户端IP地址。</li>
<li><code>$remote_user</code>: 远程用户（通常用于身份验证；如果没有，则为空）。</li>
<li><code>$request</code>: 完整的原始请求行。</li>
<li><code>$status</code>: HTTP响应状态码。</li>
<li><code>$body_bytes_sent</code>: 发送给客户端的字节数，不包括响应头的大小。</li>
<li><code>$request_time</code>: 请求处理时间，单位为秒，精度达到毫秒。</li>
<li><code>$http_referer</code>: 来源页面（即用户是从哪个页面链接过来的）。</li>
<li><code>$http_user_agent</code>: 用户代理（浏览器类型等信息）。</li>
</ul>
</li>
</ul>
<p>日志输出样例</p>
<p>基于上述配置，一条典型的Nginx访问日志记录将以如下JSON格式输出到<code>/var/log/nginx/access.log</code>文件中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;time_local&#34;</span><span class="p">:</span> <span class="s2">&#34;12/Feb/2025:17:32:00 +0000&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;remote_addr&#34;</span><span class="p">:</span> <span class="s2">&#34;192.168.1.1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;remote_user&#34;</span><span class="p">:</span> <span class="s2">&#34;-&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;request&#34;</span><span class="p">:</span> <span class="s2">&#34;GET /index.html HTTP/1.1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;status&#34;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;body_bytes_sent&#34;</span><span class="p">:</span> <span class="mi">612</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;request_time&#34;</span><span class="p">:</span> <span class="mf">0.002</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;http_referer&#34;</span><span class="p">:</span> <span class="s2">&#34;http://example.com/start.html&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;http_user_agent&#34;</span><span class="p">:</span> <span class="s2">&#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.3&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这个例子展示了一个HTTP GET请求的日志条目，其中包含了请求的各种详细信息。通过将Nginx的日志格式化为JSON，可以更方便地进行日志分析、监控以及与其他系统集成。</p>
<h4 id="日志切割">日志切割</h4>
<p><strong>日志分隔的必要性</strong></p>
<ul>
<li><strong>避免单个文件过大</strong>：长时间运行会导致日志文件占用过多磁盘空间。</li>
<li><strong>便于归档和排查</strong>：按时间或大小分隔日志，方便定位问题。</li>
<li><strong>结合压缩节省空间</strong>：压缩旧日志减少存储压力。</li>
</ul>
<hr>
<h5 id="使用-logrotate-工具推荐">使用 <code>logrotate</code> 工具（推荐）</h5>
<p><code>logrotate</code> 是Linux系统自带的日志管理工具，支持自动化轮转、压缩和删除旧日志。</p>
<h6 id="步骤"><strong>步骤：</strong></h6>
<ol>
<li>
<p><strong>编辑Nginx的logrotate配置文件</strong><br>
通常路径为 <code>/etc/logrotate.d/nginx</code>，内容如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">/var/log/nginx/*.log <span class="o">{</span>  <span class="c1"># 匹配Nginx日志路径</span>
</span></span><span class="line"><span class="cl">    daily               <span class="c1"># 按天轮转</span>
</span></span><span class="line"><span class="cl">    missingok           <span class="c1"># 日志不存在时不报错</span>
</span></span><span class="line"><span class="cl">    rotate <span class="m">14</span>           <span class="c1"># 保留最近14天的日志</span>
</span></span><span class="line"><span class="cl">    compress            <span class="c1"># 压缩旧日志（gzip）</span>
</span></span><span class="line"><span class="cl">    delaycompress       <span class="c1"># 延迟压缩前一个轮转的日志（方便排查最新旧日志）</span>
</span></span><span class="line"><span class="cl">    notifempty          <span class="c1"># 空日志不轮转</span>
</span></span><span class="line"><span class="cl">    create <span class="m">0640</span> www-data adm  <span class="c1"># 创建新日志文件并设置权限、所有者</span>
</span></span><span class="line"><span class="cl">    sharedscripts       <span class="c1"># 所有日志处理完成后执行脚本</span>
</span></span><span class="line"><span class="cl">    postrotate          <span class="c1"># 轮转后执行的命令</span>
</span></span><span class="line"><span class="cl">        <span class="o">[</span> -f /var/run/nginx.pid <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">kill</span> -USR1 <span class="sb">`</span>cat /var/run/nginx.pid<span class="sb">`</span>  <span class="c1"># 通知Nginx重新打开日志</span>
</span></span><span class="line"><span class="cl">    endscript
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><strong>测试配置</strong><br>
手动执行轮转并检查结果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">logrotate -vf /etc/logrotate.d/nginx  <span class="c1"># -v: 详细输出，-f: 强制运行</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><strong>验证日志分隔</strong><br>
检查 <code>/var/log/nginx</code> 目录是否生成类似 <code>access.log.1.gz</code> 的压缩文件，并确认Nginx正常写入新日志。</p>
</li>
</ol>
<hr>
<h5 id="关键注意事项"><strong>关键注意事项</strong></h5>
<ol>
<li>
<p><strong>权限问题</strong></p>
<ul>
<li>确保新日志文件所有者（如 <code>www-data</code>）与Nginx运行用户一致。</li>
<li><code>logrotate</code> 配置中使用 <code>create</code> 指令设置权限。</li>
</ul>
</li>
<li>
<p><strong>信号机制</strong></p>
<ul>
<li><code>kill -USR1</code> 通知Nginx重新打开日志文件，无需重启服务。</li>
<li>也可用 <code>nginx -s reopen</code> 命令实现相同效果。</li>
</ul>
</li>
<li>
<p><strong>轮转周期调整</strong></p>
<ul>
<li>修改 <code>logrotate</code> 配置中的 <code>daily</code> 为 <code>weekly</code>、<code>monthly</code> 或 <code>size</code>（如 <code>size 100M</code>）。</li>
</ul>
</li>
<li>
<p><strong>日志处理</strong></p>
<ul>
<li>使用 <code>compress</code> 和 <code>delaycompress</code> 控制压缩行为。</li>
<li>通过 <code>rotate</code> 设置保留的旧日志数量。</li>
</ul>
</li>
</ol>
<h5 id="配置多个目录的方式">配置多个目录的方式</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># /etc/logrotate.d/nginx
</span></span><span class="line"><span class="cl">/var/log/nginx/*.log {
</span></span><span class="line"><span class="cl">    daily
</span></span><span class="line"><span class="cl">    rotate 14
</span></span><span class="line"><span class="cl">    compress
</span></span><span class="line"><span class="cl">    missingok
</span></span><span class="line"><span class="cl">    create 0640 www-data adm
</span></span><span class="line"><span class="cl">    postrotate
</span></span><span class="line"><span class="cl">        nginx -s reopen
</span></span><span class="line"><span class="cl">    endscript
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># /etc/logrotate.d/nginx
</span></span><span class="line"><span class="cl">/opt/nginx/logs/*.log  /data/logs/nginx/*.log  {
</span></span><span class="line"><span class="cl">    daily
</span></span><span class="line"><span class="cl">    rotate 30
</span></span><span class="line"><span class="cl">    missingok
</span></span><span class="line"><span class="cl">    dateext
</span></span><span class="line"><span class="cl">    compress
</span></span><span class="line"><span class="cl">    delaycompress
</span></span><span class="line"><span class="cl">    notifempty
</span></span><span class="line"><span class="cl">    sharedscripts
</span></span><span class="line"><span class="cl">    postrotate
</span></span><span class="line"><span class="cl">        [ -f /opt/nginx/logs/nginx.pid ] &amp;&amp; kill -USR1 `cat /opt/nginx/logs/nginx.pid`
</span></span><span class="line"><span class="cl">    endscript
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="nginx-upsream-重试机制">Nginx upsream 重试机制</h3>
<p>探测上游服务器健康状态</p>
<ul>
<li>重试机制(被动重试机制和主动重试机制)</li>
<li>状态检查</li>
</ul>
<p>Nginx的<code>upstream</code>模块用于定义一组服务器，这些服务器可以是提供相同服务的多个后端实例。Nginx能够根据配置将请求分配给这些上游服务器，并且在某些情况下自动进行重试，这有助于提高系统的可用性和可靠性。</p>
<h4 id="被动态式重试机制">被动态式重试机制</h4>
<p>当一个请求发送到上游服务器失败时（例如由于超时、连接失败或返回了错误码），Nginx可以根据配置决定是否以及如何重试该请求。这个过程通过<code>proxy_next_upstream</code>指令来控制。它允许你指定在什么条件下Nginx应该尝试转发请求到下一个可用的上游服务器。</p>
<p><strong>可用条件包括</strong></p>
<ul>
<li><code>error</code>: 当与服务器建立连接、传递请求或读取响应头时发生错误。</li>
<li><code>timeout</code>: 超时发生时（由其他指令如<code>proxy_connect_timeout</code>, <code>proxy_read_timeout</code>等定义）。</li>
<li><code>invalid_header</code>: 服务器返回无效响应头。</li>
<li><code>http_500</code>, <code>http_502</code>, <code>http_503</code>, <code>http_504</code>: 分别对应HTTP状态码500, 502, 503和504。</li>
<li><code>non_idempotent</code>: 默认情况下，只有幂等请求（如GET, HEAD）会被重试。设置此选项可允许非幂等请求（如POST）也被重试。</li>
</ul>
<p>示例配置</p>
<p>下面是一个使用<code>proxy_next_upstream</code>的例子，展示了如何配置Nginx以实现动态式重试机制：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="k">http</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">upstream</span> <span class="s">backend</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kn">server</span> <span class="s">backend1.example.com</span> <span class="s">max_fails=5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">server</span> <span class="s">backend2.example.com</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">server</span> <span class="s">backend3.example.com</span> <span class="s">backup</span><span class="p">;</span> <span class="c1"># 备份服务器，仅当前面所有服务器都不可用时使用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kn">server</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kn">proxy_pass</span> <span class="s">http://backend</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 配置重试条件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kn">proxy_next_upstream</span> <span class="s">error</span> <span class="s">timeout</span> <span class="s">http_500</span> <span class="s">http_502</span> <span class="s">http_503</span> <span class="s">http_504</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># 设置尝试下一个上游服务器前等待的时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kn">proxy_next_upstream_timeout</span> <span class="s">60s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># 设置每个请求最多尝试多少次上游服务器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kn">proxy_next_upstream_tries</span> <span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在这个示例中</p>
<ul>
<li><strong>upstream</strong> 块定义了一个名为<code>backend</code>的组，包含三个后端服务器。最后一个标记为<code>backup</code>，这意味着只有在所有非备份服务器都无法使用时才会尝试联系它。</li>
<li>在<code>location</code>块内，<code>proxy_pass</code>指令指定了要使用的上游服务器组。</li>
<li><code>proxy_next_upstream</code>指令设置了在遇到错误、超时或收到特定HTTP状态码（500, 502, 503, 504）时尝试下一个上游服务器。</li>
<li><code>proxy_next_upstream_timeout</code>设定了尝试下一个上游服务器的最大等待时间为60秒。</li>
<li><code>proxy_next_upstream_tries</code>限制了对每个请求最多尝试3次上游服务器。</li>
</ul>
<p>通过这种方式配置，Nginx可以在面对网络波动或其他临时性故障时更加健壮，确保用户请求尽可能得到成功处理。这对于构建高可用性的Web应用至关重要。</p>
<h4 id="主动重试机制">主动重试机制</h4>
<p>主动健康检查使用tengine模块</p>
<p>tengine版本(已应用到淘宝网上了)<br>
<a href="https://github.com/yaoweibin/nginx_upstream_check_module" target="_blank" rel="noopener noreffer ">https://github.com/yaoweibin/nginx_upstream_check_module</a></p>
<p>nginx 商业版插件<br>
<a href="https://nginx.org/en/docs/http/ngx_http_upstream_hc_module.html" target="_blank" rel="noopener noreffer ">https://nginx.org/en/docs/http/ngx_http_upstream_hc_module.html</a></p>
<h2 id="参考">参考</h2>
<ul>
<li><a href="https://nginx.org/en/docs/http/ngx_http_core_module.html#http" target="_blank" rel="noopener noreffer ">https://nginx.org/en/docs/http/ngx_http_core_module.html#http</a></li>
<li><a href="https://www.digitalocean.com/community/tools/nginx?global.app.lang=zhCN" target="_blank" rel="noopener noreffer ">Nginx Config</a> 可以快速方便获得nginx的配置</li>
</ul>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2022-06-26</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://lushuan.gihub.io/nginx%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/" data-title="Nginx 常用配置" data-via="xxxx" data-hashtags="Nginx"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://lushuan.gihub.io/nginx%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/" data-hashtag="Nginx"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Hacker News" data-sharer="hackernews" data-url="https://lushuan.gihub.io/nginx%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/" data-title="Nginx 常用配置"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://lushuan.gihub.io/nginx%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/" data-title="Nginx 常用配置"><i data-svg-src="/lib/simple-icons/icons/line.min.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://lushuan.gihub.io/nginx%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/" data-title="Nginx 常用配置"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/nginx/">Nginx</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/nginx%E6%97%A5%E5%B8%B8%E5%B7%A5%E4%BD%9C%E5%B8%B8%E7%94%A8%E8%84%9A%E6%9C%AC/" class="prev" rel="prev" title="Nginx 日常工作常用脚本"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Nginx 日常工作常用脚本</a>
            <a href="/nginx%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/" class="next" rel="next" title="Nginx 安装部署">Nginx 安装部署<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
<div id="comments"><div id="gitalk" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://github.com/gitalk/gitalk"></a>Gitalk</a>.
            </noscript><div id="valine" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://valine.js.org/">Valine</a>.
            </noscript></div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">我是有底线的</div><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.114.0">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2019 - 2025</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">lushuan</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/gitalk/gitalk.min.css"><link rel="stylesheet" href="/lib/valine/valine.min.css"><link rel="stylesheet" href="/lib/lightgallery/css/lightgallery-bundle.min.css"><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script type="text/javascript" src="/lib/gitalk/gitalk.min.js"></script><script type="text/javascript" src="/lib/valine/Valine.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.stemmer.support.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.zh.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lightgallery.min.js"></script><script type="text/javascript" src="/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js"></script><script type="text/javascript" src="/lib/lightgallery/plugins/zoom/lg-zoom.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/mhchem.min.js"></script><script type="text/javascript" src="/lib/cookieconsent/cookieconsent.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":50},"comment":{"gitalk":{"admin":["lushuan"],"clientID":"Ov23liSh0yG2wy6B7XP1","clientSecret":"7184a8df973267af95c92ddeb27789417ba82469","id":"2022-01-13T12:06:37+08:00","owner":"lushuan","repo":"lushuan.github.io","title":"Nginx 常用配置"},"valine":{"appId":"XQderBhsCffEN9pw26SOSQon-MdYXbMMI","appKey":"zLUsSeN2SfcBdQbGTv9iFhFp","avatar":"mp","el":"#valine","emojiCDN":"https://cdn.jsdelivr.net/npm/emoji-datasource-google@14.0.0/img/google/64/","emojiMaps":{"100":"1f4af.png","alien":"1f47d.png","anger":"1f4a2.png","angry":"1f620.png","anguished":"1f627.png","astonished":"1f632.png","black_heart":"1f5a4.png","blue_heart":"1f499.png","blush":"1f60a.png","bomb":"1f4a3.png","boom":"1f4a5.png","broken_heart":"1f494.png","brown_heart":"1f90e.png","clown_face":"1f921.png","cold_face":"1f976.png","cold_sweat":"1f630.png","confounded":"1f616.png","confused":"1f615.png","cry":"1f622.png","crying_cat_face":"1f63f.png","cupid":"1f498.png","dash":"1f4a8.png","disappointed":"1f61e.png","disappointed_relieved":"1f625.png","dizzy":"1f4ab.png","dizzy_face":"1f635.png","drooling_face":"1f924.png","exploding_head":"1f92f.png","expressionless":"1f611.png","face_vomiting":"1f92e.png","face_with_cowboy_hat":"1f920.png","face_with_hand_over_mouth":"1f92d.png","face_with_head_bandage":"1f915.png","face_with_monocle":"1f9d0.png","face_with_raised_eyebrow":"1f928.png","face_with_rolling_eyes":"1f644.png","face_with_symbols_on_mouth":"1f92c.png","face_with_thermometer":"1f912.png","fearful":"1f628.png","flushed":"1f633.png","frowning":"1f626.png","ghost":"1f47b.png","gift_heart":"1f49d.png","green_heart":"1f49a.png","grimacing":"1f62c.png","grin":"1f601.png","grinning":"1f600.png","hankey":"1f4a9.png","hear_no_evil":"1f649.png","heart":"2764-fe0f.png","heart_decoration":"1f49f.png","heart_eyes":"1f60d.png","heart_eyes_cat":"1f63b.png","heartbeat":"1f493.png","heartpulse":"1f497.png","heavy_heart_exclamation_mark_ornament":"2763-fe0f.png","hole":"1f573-fe0f.png","hot_face":"1f975.png","hugging_face":"1f917.png","hushed":"1f62f.png","imp":"1f47f.png","innocent":"1f607.png","japanese_goblin":"1f47a.png","japanese_ogre":"1f479.png","joy":"1f602.png","joy_cat":"1f639.png","kiss":"1f48b.png","kissing":"1f617.png","kissing_cat":"1f63d.png","kissing_closed_eyes":"1f61a.png","kissing_heart":"1f618.png","kissing_smiling_eyes":"1f619.png","laughing":"1f606.png","left_speech_bubble":"1f5e8-fe0f.png","love_letter":"1f48c.png","lying_face":"1f925.png","mask":"1f637.png","money_mouth_face":"1f911.png","nauseated_face":"1f922.png","nerd_face":"1f913.png","neutral_face":"1f610.png","no_mouth":"1f636.png","open_mouth":"1f62e.png","orange_heart":"1f9e1.png","partying_face":"1f973.png","pensive":"1f614.png","persevere":"1f623.png","pleading_face":"1f97a.png","pouting_cat":"1f63e.png","purple_heart":"1f49c.png","rage":"1f621.png","relaxed":"263a-fe0f.png","relieved":"1f60c.png","revolving_hearts":"1f49e.png","right_anger_bubble":"1f5ef-fe0f.png","robot_face":"1f916.png","rolling_on_the_floor_laughing":"1f923.png","scream":"1f631.png","scream_cat":"1f640.png","see_no_evil":"1f648.png","shushing_face":"1f92b.png","skull":"1f480.png","skull_and_crossbones":"2620-fe0f.png","sleeping":"1f634.png","sleepy":"1f62a.png","slightly_frowning_face":"1f641.png","slightly_smiling_face":"1f642.png","smile":"1f604.png","smile_cat":"1f638.png","smiley":"1f603.png","smiley_cat":"1f63a.png","smiling_face_with_3_hearts":"1f970.png","smiling_imp":"1f608.png","smirk":"1f60f.png","smirk_cat":"1f63c.png","sneezing_face":"1f927.png","sob":"1f62d.png","space_invader":"1f47e.png","sparkling_heart":"1f496.png","speak_no_evil":"1f64a.png","speech_balloon":"1f4ac.png","star-struck":"1f929.png","stuck_out_tongue":"1f61b.png","stuck_out_tongue_closed_eyes":"1f61d.png","stuck_out_tongue_winking_eye":"1f61c.png","sunglasses":"1f60e.png","sweat":"1f613.png","sweat_drops":"1f4a6.png","sweat_smile":"1f605.png","thinking_face":"1f914.png","thought_balloon":"1f4ad.png","tired_face":"1f62b.png","triumph":"1f624.png","two_hearts":"1f495.png","unamused":"1f612.png","upside_down_face":"1f643.png","weary":"1f629.png","white_frowning_face":"2639-fe0f.png","white_heart":"1f90d.png","wink":"1f609.png","woozy_face":"1f974.png","worried":"1f61f.png","yawning_face":"1f971.png","yellow_heart":"1f49b.png","yum":"1f60b.png","zany_face":"1f92a.png","zipper_mouth_face":"1f910.png","zzz":"1f4a4.png"},"enableQQ":false,"highlight":true,"lang":"zh-CN","pageSize":10,"placeholder":"期待您的评论...","recordIP":true,"visitor":true}},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"lightgallery":true,"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
