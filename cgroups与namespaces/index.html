<!DOCTYPE html>
<html lang="zh-CN">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>CGroups与Namespaces - Less is more</title><meta name="Description" content="知识有两种，一种是你知道的，一种是你知道在哪里能找到的！ --塞缪尔·约翰逊"><meta property="og:url" content="http://localhost:1313/cgroups%E4%B8%8Enamespaces/">
  <meta property="og:site_name" content="Less is more">
  <meta property="og:title" content="CGroups与Namespaces">
  <meta property="og:description" content="CGroups与Namespaces 摘要 了解下容器背后的两大核心技术：CGroups 和 Namespace。 CGroups 概述 CGroups 全称为 Linux Control Group，其作">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-06-26T16:25:58+08:00">
    <meta property="article:modified_time" content="2024-06-26T16:25:58+08:00">
    <meta property="article:tag" content="Docker">
    <meta property="og:image" content="http://localhost:1313/images/avatar.png">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="http://localhost:1313/images/avatar.png">
  <meta name="twitter:title" content="CGroups与Namespaces">
  <meta name="twitter:description" content="CGroups与Namespaces 摘要 了解下容器背后的两大核心技术：CGroups 和 Namespace。 CGroups 概述 CGroups 全称为 Linux Control Group，其作">
      <meta name="twitter:site" content="@xxxx">
<meta name="application-name" content="我的网站">
<meta name="apple-mobile-web-app-title" content="我的网站"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="/images/avatar.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://localhost:1313/cgroups%E4%B8%8Enamespaces/" /><link rel="prev" href="http://localhost:1313/dockerfile%E4%BB%8B%E7%BB%8D%E5%8F%8A%E4%BC%98%E5%8C%96/" /><link rel="next" href="http://localhost:1313/%E8%B0%83%E6%95%B4%E8%8A%82%E7%82%B9pod%E9%A9%B1%E9%80%90%E6%97%B6%E9%97%B4/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "CGroups与Namespaces",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/localhost:1313\/cgroups%E4%B8%8Enamespaces\/"
        },"genre": "posts","keywords": "docker","wordcount":  4630 ,
        "url": "http:\/\/localhost:1313\/cgroups%E4%B8%8Enamespaces\/","datePublished": "2023-06-26T16:25:58+08:00","dateModified": "2024-06-26T16:25:58+08:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "lushuan"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Less is more"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/images/avatar.png"
        data-srcset="/images/avatar.png, /images/avatar.png 1.5x, /images/avatar.png 2x"
        data-sizes="auto"
        alt="/images/avatar.png"
        title="/images/avatar.png" />Less is more</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 归档 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about/" title="About"> 关于 </a><a class="menu-item" href="/friends/" title="friends"> 友链 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Less is more"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/images/avatar.png"
        data-srcset="/images/avatar.png, /images/avatar.png 1.5x, /images/avatar.png 2x"
        data-sizes="auto"
        alt="/images/avatar.png"
        title="/images/avatar.png" />Less is more</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">归档</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/" title="About">关于</a><a class="menu-item" href="/friends/" title="friends">友链</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">CGroups与Namespaces</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>lushuan</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/docker/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>Docker</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2023-06-26">2023-06-26</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;约 4630 字&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;预计阅读 10 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="true">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#cgroups-概述">CGroups 概述</a></li>
    <li><a href="#cgroup-测试">CGroup 测试</a></li>
    <li><a href="#在容器中使用-cgroups">在容器中使用 CGroups</a></li>
    <li><a href="#namespaces">Namespaces</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="cgroups与namespaces">CGroups与Namespaces</h1>
<div class="details admonition abstract open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-list-ul fa-fw" aria-hidden="true"></i>摘要<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">了解下容器背后的两大核心技术：CGroups 和 Namespace。</div>
        </div>
    </div>
<h2 id="cgroups-概述">CGroups 概述</h2>
<p>CGroups 全称为 Linux Control Group，其作用是限制一组进程使用的资源（CPU、内存等）上限，CGroups 也是 Containerd 容器技术的核心实现原理之一，首先我们需要先了解几个 CGroups 的基本概念：</p>
<ul>
<li>Task: 在 cgroup 中，task 可以理解为一个进程，但这里的进程和一般意义上的操作系统进程不太一样，实际上是进程 ID 和线程 ID 列表。</li>
<li>CGroup: 即控制组，一个控制组就是一组按照某种标准划分的 Tasks，可以理解为资源限制是以进程组为单位实现的，一个进程加入到某个控制组后，就会受到相应配置的资源限制。</li>
<li>Hierarchy: cgroup 的层级组织关系，cgroup 以树形层级组织，每个 cgroup 子节点默认继承其父 cgroup 节点的配置属性，这样每个 Hierarchy 在初始化会有 root cgroup。</li>
<li>Subsystem: 即子系统，子系统表示具体的资源配置，如 CPU 使用，内存占用等，Subsystem 附加到 Hierarchy 上后可用</li>
</ul>
<p>CGroups 支持的子系统包含以下几类，即为每种可以控制的资源定义了一个子系统:</p>
<ul>
<li>cpuset: 为 cgroup 中的进程分配单独的 CPU 节点，即可以绑定到特定的 CPU</li>
<li>cpu: 限制 cgroup 中进程的 CPU 使用份额</li>
<li>cpuacct: 统计 cgroup 中进程的 CPU 使用情况</li>
<li>memory: 限制 cgroup 中进程的内存使用,并能报告内存使用情况</li>
<li>devices: 控制 cgroup 中进程能访问哪些文件设备(设备文件的创建、读写)</li>
<li>freezer: 挂起或恢复 cgroup 中的 task</li>
<li>net_cls: 可以标记 cgroups 中进程的网络数据包，然后可以使用 tc 模块(traffic contro)对数据包进行控制</li>
<li>blkio: 限制 cgroup 中进程的块设备 IO</li>
<li>perf_event: 监控 cgroup 中进程的 perf 时间，可用于性能调优</li>
<li>hugetlb: hugetlb 的资源控制功能</li>
<li>pids: 限制 cgroup 中可以创建的进程数</li>
<li>net_prio: 允许管理员动态的通过各种应用程序设置网络传输的优先级</li>
</ul>
<p>通过上面的各个子系统，可以看出使用 CGroups 可以控制的资源有: CPU、内存、网络、IO、文件设备等。CGroups 具有以下几个特点：</p>
<ul>
<li>CGroups 的 API 以一个伪文件系统（/sys/fs/cgroup/）的实现方式，用户的程序可以通过文件系统实现 CGroups 的组件管理</li>
<li>CGroups 的组件管理操作单元可以细粒度到线程级别，用户可以创建和销毁 CGroups，从而实现资源载分配和再利用</li>
<li>所有资源管理的功能都以子系统（cpu、cpuset 这些）的方式实现，接口统一子任务创建之初与其父任务处于同一个 CGroups 的控制组</li>
</ul>
<p>我们可以通过查看 /proc/cgroups 文件来查找当前系统支持的 CGroups 子系统:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ cat /proc/cgroups
</span></span><span class="line"><span class="cl"><span class="c1">#subsys_name    hierarchy       num_cgroups     enabled</span>
</span></span><span class="line"><span class="cl">cpuset  <span class="m">5</span>       <span class="m">153</span>     <span class="m">1</span>
</span></span><span class="line"><span class="cl">cpu     <span class="m">8</span>       <span class="m">478</span>     <span class="m">1</span>
</span></span><span class="line"><span class="cl">cpuacct <span class="m">8</span>       <span class="m">478</span>     <span class="m">1</span>
</span></span><span class="line"><span class="cl">memory  <span class="m">3</span>       <span class="m">478</span>     <span class="m">1</span>
</span></span><span class="line"><span class="cl">devices <span class="m">9</span>       <span class="m">478</span>     <span class="m">1</span>
</span></span><span class="line"><span class="cl">freezer <span class="m">4</span>       <span class="m">153</span>     <span class="m">1</span>
</span></span><span class="line"><span class="cl">net_cls <span class="m">6</span>       <span class="m">153</span>     <span class="m">1</span>
</span></span><span class="line"><span class="cl">blkio   <span class="m">10</span>      <span class="m">478</span>     <span class="m">1</span>
</span></span><span class="line"><span class="cl">perf_event      <span class="m">2</span>       <span class="m">153</span>     <span class="m">1</span>
</span></span><span class="line"><span class="cl">hugetlb <span class="m">7</span>       <span class="m">153</span>     <span class="m">1</span>
</span></span><span class="line"><span class="cl">pids    <span class="m">11</span>      <span class="m">478</span>     <span class="m">1</span>
</span></span><span class="line"><span class="cl">net_prio        <span class="m">6</span>       <span class="m">153</span>     
</span></span></code></pre></td></tr></table>
</div>
</div><p>在使用 CGroups 时需要先挂载，我们可以使用 df -h | grep cgroup 命令进行查看:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ df -h <span class="p">|</span> grep cgroup
</span></span><span class="line"><span class="cl">tmpfs                          7.8G     <span class="m">0</span>  7.8G   0% /sys/fs/cgroup
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到被挂载到了 /sys/fs/cgroup，cgroup 其实是一种文件系统类型，所有的操作都是通过文件来完成的，我们可以使用 mount &ndash;type cgroup命令查看当前系统挂载了哪些 cgroup：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ mount --type cgroup
</span></span><span class="line"><span class="cl">cgroup on /sys/fs/cgroup/systemd type cgroup (rw,nosuid,nodev,noexec,relatime,xattr,release_agent=/usr/lib/systemd/systemd-cgroups-agent,name=systemd)
</span></span><span class="line"><span class="cl">cgroup on /sys/fs/cgroup/perf_event type cgroup (rw,nosuid,nodev,noexec,relatime,perf_event)
</span></span><span class="line"><span class="cl">cgroup on /sys/fs/cgroup/memory type cgroup (rw,nosuid,nodev,noexec,relatime,memory)
</span></span><span class="line"><span class="cl">cgroup on /sys/fs/cgroup/freezer type cgroup (rw,nosuid,nodev,noexec,relatime,freezer)
</span></span><span class="line"><span class="cl">cgroup on /sys/fs/cgroup/cpuset type cgroup (rw,nosuid,nodev,noexec,relatime,cpuset)
</span></span><span class="line"><span class="cl">cgroup on /sys/fs/cgroup/net_cls,net_prio type cgroup (rw,nosuid,nodev,noexec,relatime,net_prio,net_cls)
</span></span><span class="line"><span class="cl">cgroup on /sys/fs/cgroup/hugetlb type cgroup (rw,nosuid,nodev,noexec,relatime,hugetlb)
</span></span><span class="line"><span class="cl">cgroup on /sys/fs/cgroup/cpu,cpuacct type cgroup (rw,nosuid,nodev,noexec,relatime,cpuacct,cpu)
</span></span><span class="line"><span class="cl">cgroup on /sys/fs/cgroup/devices type cgroup (rw,nosuid,nodev,noexec,relatime,devices)
</span></span><span class="line"><span class="cl">cgroup on /sys/fs/cgroup/blkio type cgroup (rw,nosuid,nodev,noexec,relatime,blkio)
</span></span><span class="line"><span class="cl">cgroup on /sys/fs/cgroup/pids type cgroup (rw,nosuid,nodev,noexec,relatime,pids)
</span></span></code></pre></td></tr></table>
</div>
</div><p>/sys/fs/cgroup 目录下的每个子目录就对应着一个子系统，cgroup 是以目录形式组织的，/ 是 cgroup 的根目录，但是这个根目录可以被挂载到任意目录，例如 CGroups 的 memory 子系统的挂载点是 /sys/fs/cgroup/memory，那么 /sys/fs/cgroup/memory/ 对应 memory 子系统的根目录，我们可以列出该目录下面的文件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ ll /sys/fs/cgroup/memory/
</span></span><span class="line"><span class="cl">total <span class="m">0</span>
</span></span><span class="line"><span class="cl">-rw-r--r--   <span class="m">1</span> root root <span class="m">0</span> Aug  <span class="m">8</span>  <span class="m">2022</span> cgroup.clone_children
</span></span><span class="line"><span class="cl">--w--w--w-   <span class="m">1</span> root root <span class="m">0</span> Aug  <span class="m">8</span>  <span class="m">2022</span> cgroup.event_control
</span></span><span class="line"><span class="cl">-rw-r--r--   <span class="m">1</span> root root <span class="m">0</span> Aug  <span class="m">8</span>  <span class="m">2022</span> cgroup.procs
</span></span><span class="line"><span class="cl">-r--r--r--   <span class="m">1</span> root root <span class="m">0</span> Aug  <span class="m">8</span>  <span class="m">2022</span> cgroup.sane_behavior
</span></span><span class="line"><span class="cl">drwxr-xr-x   <span class="m">5</span> root root <span class="m">0</span> Aug <span class="m">28</span> 14:38 docker
</span></span><span class="line"><span class="cl">drwxr-xr-x   <span class="m">5</span> root root <span class="m">0</span> Sep  <span class="m">6</span> 14:01 kubepods
</span></span><span class="line"><span class="cl">-rw-r--r--   <span class="m">1</span> root root <span class="m">0</span> Aug  <span class="m">8</span>  <span class="m">2022</span> memory.failcnt
</span></span><span class="line"><span class="cl">--w-------   <span class="m">1</span> root root <span class="m">0</span> Aug  <span class="m">8</span>  <span class="m">2022</span> memory.force_empty
</span></span><span class="line"><span class="cl">-rw-r--r--   <span class="m">1</span> root root <span class="m">0</span> Aug  <span class="m">8</span>  <span class="m">2022</span> memory.kmem.failcnt
</span></span><span class="line"><span class="cl">-rw-r--r--   <span class="m">1</span> root root <span class="m">0</span> Aug  <span class="m">8</span>  <span class="m">2022</span> memory.kmem.limit_in_bytes
</span></span><span class="line"><span class="cl">-rw-r--r--   <span class="m">1</span> root root <span class="m">0</span> Aug  <span class="m">8</span>  <span class="m">2022</span> memory.kmem.max_usage_in_bytes
</span></span><span class="line"><span class="cl">-r--r--r--   <span class="m">1</span> root root <span class="m">0</span> Aug  <span class="m">8</span>  <span class="m">2022</span> memory.kmem.slabinfo
</span></span><span class="line"><span class="cl">-rw-r--r--   <span class="m">1</span> root root <span class="m">0</span> Aug  <span class="m">8</span>  <span class="m">2022</span> memory.kmem.tcp.failcnt
</span></span><span class="line"><span class="cl">-rw-r--r--   <span class="m">1</span> root root <span class="m">0</span> Aug  <span class="m">8</span>  <span class="m">2022</span> memory.kmem.tcp.limit_in_bytes
</span></span><span class="line"><span class="cl">-rw-r--r--   <span class="m">1</span> root root <span class="m">0</span> Aug  <span class="m">8</span>  <span class="m">2022</span> memory.kmem.tcp.max_usage_in_bytes
</span></span><span class="line"><span class="cl">-r--r--r--   <span class="m">1</span> root root <span class="m">0</span> Aug  <span class="m">8</span>  <span class="m">2022</span> memory.kmem.tcp.usage_in_bytes
</span></span><span class="line"><span class="cl">-r--r--r--   <span class="m">1</span> root root <span class="m">0</span> Aug  <span class="m">8</span>  <span class="m">2022</span> memory.kmem.usage_in_bytes
</span></span><span class="line"><span class="cl">-rw-r--r--   <span class="m">1</span> root root <span class="m">0</span> Aug  <span class="m">8</span>  <span class="m">2022</span> memory.limit_in_bytes
</span></span><span class="line"><span class="cl">-rw-r--r--   <span class="m">1</span> root root <span class="m">0</span> Aug  <span class="m">8</span>  <span class="m">2022</span> memory.max_usage_in_bytes
</span></span><span class="line"><span class="cl">-rw-r--r--   <span class="m">1</span> root root <span class="m">0</span> Aug  <span class="m">8</span>  <span class="m">2022</span> memory.memsw.failcnt
</span></span><span class="line"><span class="cl">-rw-r--r--   <span class="m">1</span> root root <span class="m">0</span> Aug  <span class="m">8</span>  <span class="m">2022</span> memory.memsw.limit_in_bytes
</span></span><span class="line"><span class="cl">-rw-r--r--   <span class="m">1</span> root root <span class="m">0</span> Aug  <span class="m">8</span>  <span class="m">2022</span> memory.memsw.max_usage_in_bytes
</span></span><span class="line"><span class="cl">-r--r--r--   <span class="m">1</span> root root <span class="m">0</span> Aug  <span class="m">8</span>  <span class="m">2022</span> memory.memsw.usage_in_bytes
</span></span><span class="line"><span class="cl">-rw-r--r--   <span class="m">1</span> root root <span class="m">0</span> Aug  <span class="m">8</span>  <span class="m">2022</span> memory.move_charge_at_immigrate
</span></span><span class="line"><span class="cl">-r--r--r--   <span class="m">1</span> root root <span class="m">0</span> Aug  <span class="m">8</span>  <span class="m">2022</span> memory.numa_stat
</span></span><span class="line"><span class="cl">-rw-r--r--   <span class="m">1</span> root root <span class="m">0</span> Aug  <span class="m">8</span>  <span class="m">2022</span> memory.oom_control
</span></span><span class="line"><span class="cl">----------   <span class="m">1</span> root root <span class="m">0</span> Aug  <span class="m">8</span>  <span class="m">2022</span> memory.pressure_level
</span></span><span class="line"><span class="cl">-rw-r--r--   <span class="m">1</span> root root <span class="m">0</span> Aug  <span class="m">8</span>  <span class="m">2022</span> memory.soft_limit_in_bytes
</span></span><span class="line"><span class="cl">-r--r--r--   <span class="m">1</span> root root <span class="m">0</span> Aug  <span class="m">8</span>  <span class="m">2022</span> memory.stat
</span></span><span class="line"><span class="cl">-rw-r--r--   <span class="m">1</span> root root <span class="m">0</span> Aug  <span class="m">8</span>  <span class="m">2022</span> memory.swappiness
</span></span><span class="line"><span class="cl">-r--r--r--   <span class="m">1</span> root root <span class="m">0</span> Aug  <span class="m">8</span>  <span class="m">2022</span> memory.usage_in_bytes
</span></span><span class="line"><span class="cl">-rw-r--r--   <span class="m">1</span> root root <span class="m">0</span> Aug  <span class="m">8</span>  <span class="m">2022</span> memory.use_hierarchy
</span></span><span class="line"><span class="cl">-rw-r--r--   <span class="m">1</span> root root <span class="m">0</span> Aug  <span class="m">8</span>  <span class="m">2022</span> notify_on_release
</span></span><span class="line"><span class="cl">-rw-r--r--   <span class="m">1</span> root root <span class="m">0</span> Aug  <span class="m">8</span>  <span class="m">2022</span> release_agent
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">325</span> root root <span class="m">0</span> Sep <span class="m">10</span> 17:05 system.slice
</span></span><span class="line"><span class="cl">-rw-r--r--   <span class="m">1</span> root root <span class="m">0</span> Aug  <span class="m">8</span>  <span class="m">2022</span> tasks
</span></span><span class="line"><span class="cl">drwxr-xr-x   <span class="m">2</span> root root <span class="m">0</span> Aug <span class="m">11</span>  <span class="m">2022</span> user.slice
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面包含 kubepods.slice、system.slice、user.slice 等目录，这些目录下可能还会有子目录，相当于一颗有层级关系的树来进行组织</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/
</span></span><span class="line"><span class="cl">├── kubepods.slice
</span></span><span class="line"><span class="cl">├── system.slice
</span></span><span class="line"><span class="cl">└── user.slice
</span></span></code></pre></td></tr></table>
</div>
</div><p>例如我在节点上使用 systemd 管理了一个 node_exporter 的应用，我们可以使用 systemctl status node_exporter 命令查看 node_exporter 进程所在的 cgroup 为 /system.slice/node_exporter.service:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ systemctl status node_exporter
</span></span><span class="line"><span class="cl">● node_exporter.service - node_exporter service daemon
</span></span><span class="line"><span class="cl">   Loaded: loaded <span class="o">(</span>/usr/lib/systemd/system/node_exporter.service<span class="p">;</span> enabled<span class="p">;</span> vendor preset: disabled<span class="o">)</span>
</span></span><span class="line"><span class="cl">   Active: active <span class="o">(</span>running<span class="o">)</span> since Fri 2023-09-08 09:04:02 CST<span class="p">;</span> <span class="m">3</span> days ago
</span></span><span class="line"><span class="cl"> Main PID: <span class="m">36428</span> <span class="o">(</span>node_exporter<span class="o">)</span>
</span></span><span class="line"><span class="cl">    Tasks: <span class="m">29</span>
</span></span><span class="line"><span class="cl">   Memory: 28.3M
</span></span><span class="line"><span class="cl">   CGroup: /system.slice/node_exporter.service
</span></span><span class="line"><span class="cl">           └─36428 /usr/sbin/node_exporter --collector.processes --collector.systemd --collector.textfile.directory /var/lib/node_exporter/textfile_collector
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Sep <span class="m">08</span> 09:04:02 crms-10-10-192-220 node_exporter<span class="o">[</span>36428<span class="o">]</span>: <span class="nv">level</span><span class="o">=</span>info <span class="nv">ts</span><span class="o">=</span>2023-09-08T01:04:02.098Z <span class="nv">caller</span><span class="o">=</span>node_exporter.go:113 <span class="nv">collector</span><span class="o">=</span>thermal_zone
</span></span><span class="line"><span class="cl">Sep <span class="m">08</span> 09:04:02 crms-10-10-192-220 node_exporter<span class="o">[</span>36428<span class="o">]</span>: <span class="nv">level</span><span class="o">=</span>info <span class="nv">ts</span><span class="o">=</span>2023-09-08T01:04:02.098Z <span class="nv">caller</span><span class="o">=</span>node_exporter.go:113 <span class="nv">collector</span><span class="o">=</span><span class="nb">time</span>
</span></span><span class="line"><span class="cl">Sep <span class="m">08</span> 09:04:02 crms-10-10-192-220 node_exporter<span class="o">[</span>36428<span class="o">]</span>: <span class="nv">level</span><span class="o">=</span>info <span class="nv">ts</span><span class="o">=</span>2023-09-08T01:04:02.098Z <span class="nv">caller</span><span class="o">=</span>node_exporter.go:113 <span class="nv">collector</span><span class="o">=</span>timex
</span></span><span class="line"><span class="cl">Sep <span class="m">08</span> 09:04:02 crms-10-10-192-220 node_exporter<span class="o">[</span>36428<span class="o">]</span>: <span class="nv">level</span><span class="o">=</span>info <span class="nv">ts</span><span class="o">=</span>2023-09-08T01:04:02.098Z <span class="nv">caller</span><span class="o">=</span>node_exporter.go:113 <span class="nv">collector</span><span class="o">=</span>udp_queues
</span></span><span class="line"><span class="cl">Sep <span class="m">08</span> 09:04:02 crms-10-10-192-220 node_exporter<span class="o">[</span>36428<span class="o">]</span>: <span class="nv">level</span><span class="o">=</span>info <span class="nv">ts</span><span class="o">=</span>2023-09-08T01:04:02.098Z <span class="nv">caller</span><span class="o">=</span>node_exporter.go:113 <span class="nv">collector</span><span class="o">=</span>uname
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面显示的 CGroup 只是一个相对的路径，实际的文件系统目录是在对应的子系统下面，比如 /sys/fs/cgroup/cpu/system.slice/node_exporter.service、/sys/fs/cgroup/memory/system.slice/node_exporter.service 目录：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ ls /sys/fs/cgroup/cpu/system.slice/node_exporter.service
</span></span><span class="line"><span class="cl">cgroup.clone_children  cgroup.procs  cpuacct.usage         cpu.cfs_period_us  cpu.rt_period_us   cpu.shares  notify_on_release
</span></span><span class="line"><span class="cl">cgroup.event_control   cpuacct.stat  cpuacct.usage_percpu  cpu.cfs_quota_us   cpu.rt_runtime_us  cpu.stat    tasks
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ ls /sys/fs/cgroup/memory/system.slice/node_exporter.service
</span></span><span class="line"><span class="cl">cgroup.clone_children  memory.kmem.failcnt             memory.kmem.tcp.limit_in_bytes      memory.max_usage_in_bytes        memory.move_charge_at_immigrate  memory.stat            tasks
</span></span><span class="line"><span class="cl">cgroup.event_control   memory.kmem.limit_in_bytes      memory.kmem.tcp.max_usage_in_bytes  memory.memsw.failcnt             memory.numa_stat                 memory.swappiness
</span></span><span class="line"><span class="cl">cgroup.procs           memory.kmem.max_usage_in_bytes  memory.kmem.tcp.usage_in_bytes      memory.memsw.limit_in_bytes      memory.oom_control               memory.usage_in_bytes
</span></span><span class="line"><span class="cl">memory.failcnt         memory.kmem.slabinfo            memory.kmem.usage_in_bytes          memory.memsw.max_usage_in_bytes  memory.pressure_level            memory.use_hierarchy
</span></span><span class="line"><span class="cl">memory.force_empty     memory.kmem.tcp.failcnt         memory.limit_in_bytes               memory.memsw.usage_in_bytes      memory.soft_limit_in_bytes       notify_on_release
</span></span></code></pre></td></tr></table>
</div>
</div><p>这其实可以理解为 cpu 和 memory 子系统被附加到了 /system.slice/node_exporter.service 这个 cgroup 上。</p>
<p><code>如果 linux 系统使用 systemd 初始化系统，初始化进程会生成一个 root cgroup，每个 systemd unit 都将会被分配一个 cgroup，同样可以配置容器运行时如 containerd 选择使用 cgroupfs 或 systemd 作为 cgroup 驱动，containerd 默认使用的是 cgroupfs，但对于使用了 systemd 的 linux 发行版来说就同时存在两个 cgroup 管理器，对于该服务器上启动的容器使用的是 cgroupfs，而对于其他 systemd 管理的进程使用的是 systemd，这样在服务器资源负载高的情况下可能会变的不稳定。因此对于使用了 systemd 的 linux 系统，推荐将容器运行时的 cgroup 驱动使用 systemd。</code></p>
<h2 id="cgroup-测试">CGroup 测试</h2>
<p>接下来我们来尝试手动设置下 cgroup，以 CPU 这个子系统为例进行说明，首先我们在 /sys/fs/cgroup/cpu 目录下面创建一个名为 ydzs.test 的目录：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ mkdir -p /sys/fs/cgroup/cpu/ydzs.test
</span></span><span class="line"><span class="cl">$ ls /sys/fs/cgroup/cpu/ydzs.test/
</span></span><span class="line"><span class="cl">cgroup.clone_children  cpuacct.stat          cpu.cfs_period_us  cpu.rt_runtime_us  notify_on_release
</span></span><span class="line"><span class="cl">cgroup.event_control   cpuacct.usage         cpu.cfs_quota_us   cpu.shares         tasks
</span></span><span class="line"><span class="cl">cgroup.procs           cpuacct.usage_percpu  cpu.rt_period_us   cpu.stat
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们可以看到目录创建完成后，下面就会已经自动创建 cgroup 的相关文件，这里我们重点关注 cpu.cfs_period_us 和 cpu.cfs_quota_us 这两个文件，前面一个是用来配置 CPU 时间周期长度的，默认为 100000us，后者用来设置在此时间周期长度内所能使用的 CPU 时间数，默认值为-1，表示不受时间限制。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ cat /sys/fs/cgroup/cpu/ydzs.test/cpu.cfs_period_us
</span></span><span class="line"><span class="cl"><span class="m">100000</span>
</span></span><span class="line"><span class="cl">$ cat /sys/fs/cgroup/cpu/ydzs.test/cpu.cfs_quota_us
</span></span><span class="line"><span class="cl">-1
</span></span></code></pre></td></tr></table>
</div>
</div><p>现在我们写一个简单的 Python 脚本来消耗 CPU：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># cgroup.py</span>
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">pass</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>直接执行这个死循环脚本即可：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ python cgroup.py &amp;
</span></span><span class="line"><span class="cl">[1] 2113
</span></span></code></pre></td></tr></table>
</div>
</div><p>使用 top 命令可以看到进程号 2113 的 CPU 使用率达到了 100%</p>
<p>现在我们将这个进程 ID 写入到 /sys/fs/cgroup/cpu/ydzs.test/tasks 文件下面去，然后设置 /sys/fs/cgroup/cpu/ydzs.test/cpu.cfs_quota_us 为 10000us，因为 cpu.cfs_period_us 默认值为 100000us，所以这表示我们要限制 CPU 使用率为 10%：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ <span class="nb">echo</span> <span class="m">2113</span> &gt; /sys/fs/cgroup/cpu/ydzs.test/tasks
</span></span><span class="line"><span class="cl">$ <span class="nb">echo</span> <span class="m">10000</span> &gt; /sys/fs/cgroup/cpu/ydzs.test/cpu.cfs_quota_us
</span></span></code></pre></td></tr></table>
</div>
</div><p>设置完过后上面我们的测试进程 CPU 就会被限制在 10% 左右了，再次使用 top 命令查看该进程可以验证。</p>
<p>如果要限制内存等其他资源的话，同样去对应的子系统下面设置资源，并将进程 ID 加入 tasks 中即可。如果要删除这个 cgroup，直接删除文件夹是不行的，需要使用 libcgroup 工具：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ yum install libcgroup libcgroup-tools
</span></span><span class="line"><span class="cl">$ cgdelete cpu:ydzs.test
</span></span><span class="line"><span class="cl">$ ls /sys/fs/cgroup/cpu/ydzs.test
</span></span><span class="line"><span class="cl">ls: cannot access /sys/fs/cgroup/cpu/ydzs.test: No such file or directory
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="在容器中使用-cgroups">在容器中使用 CGroups</h2>
<p>上面我们测试了一个普通应用如何配置 cgroup，接下来我们在 Containerd 的容器中来使用 cgroup，比如使用 nerdctl 启动一个 nginx 容器，并限制其使用内存为 50M:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ nerdctl run -d -m 50m --name nginx nginx:alpine
</span></span><span class="line"><span class="cl">8690c7dba4ffe03d63983555c594e2784c146b5f9939de1195a9626339c9129c
</span></span><span class="line"><span class="cl">$ nerdctl ps
</span></span><span class="line"><span class="cl">CONTAINER ID    IMAGE                             COMMAND                   CREATED           STATUS    PORTS    NAMES
</span></span><span class="line"><span class="cl">8690c7dba4ff    docker.io/library/nginx:alpine    &#34;/docker-entrypoint.…&#34;    53 seconds ago    Up                 nginx
</span></span></code></pre></td></tr></table>
</div>
</div><p>在使用 nerdctl run 启动容器的时候可以使用 -m 或 &ndash;memory 参数来限制内存，启动完成后该容器的 cgroup 会出现在 名为 default 的目录下面，比如查看内存子系统的目录：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ ll /sys/fs/cgroup/memory/default/
</span></span><span class="line"><span class="cl">total 0
</span></span><span class="line"><span class="cl">drwxr-xr-x 2 root root 0 Oct 21 15:01 8690c7dba4ffe03d63983555c594e2784c146b5f9939de1195a9626339c9129c
</span></span><span class="line"><span class="cl">-rw-r--r-- 1 root root 0 Oct 21 15:01 cgroup.clone_children
</span></span><span class="line"><span class="cl">--w--w--w- 1 root root 0 Oct 21 15:01 cgroup.event_control
</span></span><span class="line"><span class="cl">-rw-r--r-- 1 root root 0 Oct 21 15:01 cgroup.procs
</span></span><span class="line"><span class="cl">......
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面我们启动的 nginx 容器 ID 的目录会出现在 /sys/fs/cgroup/memory/default/ 下面，该文件夹下面有很多和内存相关的 cgroup 配置文件，要进行相关的配置就需要在该目录下对应的文件中去操作：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ ll /sys/fs/cgroup/memory/default/8690c7dba4ffe03d63983555c594e2784c146b5f9939de1195a9626339c9129c
</span></span><span class="line"><span class="cl">total 0
</span></span><span class="line"><span class="cl">-rw-r--r-- 1 root root 0 Oct 21 15:01 cgroup.clone_children
</span></span><span class="line"><span class="cl">--w--w--w- 1 root root 0 Oct 21 15:01 cgroup.event_control
</span></span><span class="line"><span class="cl">-rw-r--r-- 1 root root 0 Oct 21 15:01 cgroup.procs
</span></span><span class="line"><span class="cl">-rw-r--r-- 1 root root 0 Oct 21 15:01 memory.failcnt
</span></span><span class="line"><span class="cl">--w------- 1 root root 0 Oct 21 15:01 memory.force_empty
</span></span><span class="line"><span class="cl">-rw-r--r-- 1 root root 0 Oct 21 15:01 memory.kmem.failcnt
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们这里需要关心的是 memory.limit_in_bytes 文件，该文件就是用来设置内存大小的，正常应该是 50M 的内存限制：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ cat /sys/fs/cgroup/memory/default/8690c7dba4ffe03d63983555c594e2784c146b5f9939de1195a9626339c9129c/memory.limit_in_bytes
</span></span><span class="line"><span class="cl">52428800
</span></span></code></pre></td></tr></table>
</div>
</div><p>同样我们的 nginx 容器进程 ID 也会出现在上面的 tasks 文件中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ cat /sys/fs/cgroup/memory/default/8690c7dba4ffe03d63983555c594e2784c146b5f9939de1195a9626339c9129c/tasks
</span></span><span class="line"><span class="cl">2686
</span></span><span class="line"><span class="cl">2815
</span></span><span class="line"><span class="cl">2816
</span></span><span class="line"><span class="cl">2817
</span></span><span class="line"><span class="cl">2818
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们可以通过如下命令过滤该进程号，可以看出第一行的 2686 就是 nginx 进程在主机上的进程 ID，下面几个是这个进程下的线程：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ ps -ef | grep 2686
</span></span><span class="line"><span class="cl">root       2686   2656  0 15:01 ?        00:00:00 nginx: master process nginx -g daemon off;
</span></span><span class="line"><span class="cl">101        2815   2686  0 15:01 ?        00:00:00 nginx: worker process
</span></span><span class="line"><span class="cl">101        2816   2686  0 15:01 ?        00:00:00 nginx: worker process
</span></span><span class="line"><span class="cl">101        2817   2686  0 15:01 ?        00:00:00 nginx: worker process
</span></span><span class="line"><span class="cl">101        2818   2686  0 15:01 ?        00:00:00 nginx: worker process
</span></span><span class="line"><span class="cl">root       2950   1976  0 15:36 pts/0    00:00:00 grep --color=auto 2686
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们删除这个容器后，/sys/fs/cgroup/memory/default/ 目录下的容器 ID 文件夹也会自动删除。</p>
<h2 id="namespaces">Namespaces</h2>
<p>namespace 也称命名空间，是 Linux 为我们提供的用于隔离进程树、网络接口、挂载点以及进程间通信等资源的方法。在日常使用个人 PC 时，我们并没有运行多个完全分离的服务器的需求，但是如果我们在服务器上启动了多个服务，这些服务其实会相互影响的，每一个服务都能看到其他服务的进程，也可以访问宿主机器上的任意文件，一旦服务器上的某一个服务被入侵，那么入侵者就能够访问当前机器上的所有服务和文件，这是我们不愿意看到的，我们更希望运行在同一台机器上的不同服务能做到完全隔离，就像运行在多台不同的机器上一样。而我们这里的容器其实就通过 Linux 的 Namespaces 技术来实现的对不同的容器进行隔离。</p>
<p>linux 共有 6(7)种命名空间:</p>
<ul>
<li>ipc namespace: 管理对 IPC 资源（进程间通信（信号量、消息队列和共享内存）的访问</li>
<li>net namespace: 网络设备、网络栈、端口等隔离</li>
<li>mnt namespace: 文件系统挂载点隔离</li>
<li>pid namespace: 用于进程隔离</li>
<li>user namespace: 用户和用户组隔离（3.8 以后的内核才支持）</li>
<li>uts namespace: 主机和域名隔离</li>
<li>cgroup namespace：用于 cgroup 根目录隔离（4.6 以后版本的内核才支持）</li>
</ul>
<p>我们可以通过 lsns 命令查看当前系统已经创建的命名空间：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># lsns|more</span>
</span></span><span class="line"><span class="cl">        NS TYPE  NPROCS   PID USER          COMMAND
</span></span><span class="line"><span class="cl"><span class="m">4026531836</span> pid      <span class="m">600</span>     <span class="m">1</span> root          /usr/lib/systemd/systemd --switched-root --system --deserialize <span class="m">22</span>
</span></span><span class="line"><span class="cl"><span class="m">4026531837</span> user     <span class="m">946</span>     <span class="m">1</span> root          /usr/lib/systemd/systemd --switched-root --system --deserialize <span class="m">22</span>
</span></span><span class="line"><span class="cl"><span class="m">4026531838</span> uts      <span class="m">629</span>     <span class="m">1</span> root          /usr/lib/systemd/systemd --switched-root --system --deserialize <span class="m">22</span>
</span></span><span class="line"><span class="cl"><span class="m">4026531839</span> ipc      <span class="m">600</span>     <span class="m">1</span> root          /usr/lib/systemd/systemd --switched-root --system --deserialize <span class="m">22</span>
</span></span><span class="line"><span class="cl"><span class="m">4026531840</span> mnt      <span class="m">591</span>     <span class="m">1</span> root          /usr/lib/systemd/systemd --switched-root --system --deserialize <span class="m">22</span>
</span></span><span class="line"><span class="cl"><span class="m">4026531856</span> mnt        <span class="m">1</span>    <span class="m">88</span> root          kdevtmpfs
</span></span><span class="line"><span class="cl"><span class="m">4026531956</span> net      <span class="m">643</span>     <span class="m">1</span> root          /usr/lib/systemd/systemd --switched-root --system --deserialize <span class="m">22</span>
</span></span><span class="line"><span class="cl"><span class="m">4026532450</span> mnt        <span class="m">1</span>  <span class="m">6635</span> chrony        /usr/sbin/chronyd
</span></span><span class="line"><span class="cl"><span class="m">4026532451</span> mnt        <span class="m">1</span>  <span class="m">6660</span> root          /usr/sbin/NetworkManager --no-daemon
</span></span></code></pre></td></tr></table>
</div>
</div><p>要查看一个进程所属的命名空间信息，可以到 /proc/<pid>/ns 目录下查看：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># ps -ef|grep chronyd</span>
</span></span><span class="line"><span class="cl">chrony    <span class="m">6635</span>     <span class="m">1</span>  <span class="m">0</span> May11 ?        00:00:50 /usr/sbin/chronyd
</span></span><span class="line"><span class="cl">root     <span class="m">17096</span> <span class="m">25474</span>  <span class="m">0</span> 17:38 pts/1    00:00:00 grep --color<span class="o">=</span>auto chronyd
</span></span><span class="line"><span class="cl"><span class="c1"># ll /proc/6635/ns</span>
</span></span><span class="line"><span class="cl">total <span class="m">0</span>
</span></span><span class="line"><span class="cl">lrwxrwxrwx <span class="m">1</span> root root <span class="m">0</span> Sep <span class="m">11</span> 17:23 ipc -&gt; ipc:<span class="o">[</span>4026531839<span class="o">]</span>
</span></span><span class="line"><span class="cl">lrwxrwxrwx <span class="m">1</span> root root <span class="m">0</span> Sep <span class="m">11</span> 17:23 mnt -&gt; mnt:<span class="o">[</span>4026532450<span class="o">]</span>
</span></span><span class="line"><span class="cl">lrwxrwxrwx <span class="m">1</span> root root <span class="m">0</span> Sep <span class="m">11</span> 17:23 net -&gt; net:<span class="o">[</span>4026531956<span class="o">]</span>
</span></span><span class="line"><span class="cl">lrwxrwxrwx <span class="m">1</span> root root <span class="m">0</span> Sep <span class="m">11</span> 17:23 pid -&gt; pid:<span class="o">[</span>4026531836<span class="o">]</span>
</span></span><span class="line"><span class="cl">lrwxrwxrwx <span class="m">1</span> root root <span class="m">0</span> Sep <span class="m">11</span> 17:23 user -&gt; user:<span class="o">[</span>4026531837<span class="o">]</span>
</span></span><span class="line"><span class="cl">lrwxrwxrwx <span class="m">1</span> root root <span class="m">0</span> Sep <span class="m">11</span> 17:23 uts -&gt; uts:<span class="o">[</span>4026531838<span class="o">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这些 namespace 都是链接文件, 格式为 namespaceType:[inode number]，inode number 用来标识一个 namespace，可以理解为 namespace id，如果两个进程的某个命名空间的链接文件指向同一个，那么其相关资源在同一个命名空间中，也就没有隔离了。比如同样针对上面运行的 nginx 容器，我们查看其命名空间：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># lsns  |grep nginx</span>
</span></span><span class="line"><span class="cl"><span class="m">4026533147</span> mnt       <span class="m">17</span> <span class="m">25233</span> <span class="m">10000</span>         nginx: master process nginx -g daemon off
</span></span><span class="line"><span class="cl"><span class="m">4026533148</span> uts       <span class="m">17</span> <span class="m">25233</span> <span class="m">10000</span>         nginx: master process nginx -g daemon off
</span></span><span class="line"><span class="cl"><span class="m">4026533149</span> ipc       <span class="m">17</span> <span class="m">25233</span> <span class="m">10000</span>         nginx: master process nginx -g daemon off
</span></span><span class="line"><span class="cl"><span class="m">4026533150</span> pid       <span class="m">17</span> <span class="m">25233</span> <span class="m">10000</span>         nginx: master process nginx -g daemon off
</span></span><span class="line"><span class="cl"><span class="m">4026533152</span> net       <span class="m">17</span> <span class="m">25233</span> <span class="m">10000</span>         nginx: master process nginx -g daemon off
</span></span><span class="line"><span class="cl"><span class="m">4026533313</span> mnt       <span class="m">17</span> <span class="m">25604</span> <span class="m">10000</span>         nginx: master process nginx -g daemon off
</span></span><span class="line"><span class="cl"><span class="m">4026533314</span> uts       <span class="m">17</span> <span class="m">25604</span> <span class="m">10000</span>         nginx: master process nginx -g daemon off
</span></span><span class="line"><span class="cl"><span class="m">4026533315</span> ipc       <span class="m">17</span> <span class="m">25604</span> <span class="m">10000</span>         nginx: master process nginx -g daemon off
</span></span><span class="line"><span class="cl"><span class="m">4026533316</span> pid       <span class="m">17</span> <span class="m">25604</span> <span class="m">10000</span>         nginx: master process nginx -g daemon off
</span></span><span class="line"><span class="cl"><span class="m">4026533318</span> net       <span class="m">17</span> <span class="m">25604</span> <span class="m">10000</span>         nginx: master process nginx -g daemon off
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看出 nginx 容器启动后，已经为该容器自动创建了单独的 mtn、uts、ipc、pid、net 命名空间，也就是这个容器在这些方面是独立隔离的，其他容器想要和该容器共享某一个命名空间，那么就需要指向同一个命名空间。</p>
<h2 id="参考">参考</h2>
<ol>
<li><a href="https://kubernetes.io/zh-cn/docs/setup/production-environment/container-runtimes/" target="_blank" rel="noopener noreffer ">https://kubernetes.io/zh-cn/docs/setup/production-environment/container-runtimes/</a></li>
<li><a href="https://www.infoq.cn/article/docker-resource-management-cgroups/" target="_blank" rel="noopener noreffer ">https://www.infoq.cn/article/docker-resource-management-cgroups/</a></li>
</ol>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2024-06-26</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="http://localhost:1313/cgroups%E4%B8%8Enamespaces/" data-title="CGroups与Namespaces" data-via="xxxx" data-hashtags="docker"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="http://localhost:1313/cgroups%E4%B8%8Enamespaces/" data-hashtag="docker"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Hacker News" data-sharer="hackernews" data-url="http://localhost:1313/cgroups%E4%B8%8Enamespaces/" data-title="CGroups与Namespaces"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="http://localhost:1313/cgroups%E4%B8%8Enamespaces/" data-title="CGroups与Namespaces"><i data-svg-src="/lib/simple-icons/icons/line.min.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="http://localhost:1313/cgroups%E4%B8%8Enamespaces/" data-title="CGroups与Namespaces"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/docker/">Docker</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/dockerfile%E4%BB%8B%E7%BB%8D%E5%8F%8A%E4%BC%98%E5%8C%96/" class="prev" rel="prev" title="Dockerfile介绍及优化"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Dockerfile介绍及优化</a>
            <a href="/%E8%B0%83%E6%95%B4%E8%8A%82%E7%82%B9pod%E9%A9%B1%E9%80%90%E6%97%B6%E9%97%B4/" class="next" rel="next" title="调整节点pod驱逐时间">调整节点pod驱逐时间<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>

</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">我是有底线的</div><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.126.0">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2019 - 2024</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">lushuan</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.stemmer.support.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.zh.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/mhchem.min.js"></script><script type="text/javascript" src="/lib/cookieconsent/cookieconsent.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":50},"comment":{},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
